# üîç TODO LIST - PROBL√àME D'AUDIT ‚Üí Table `1_historique_supabase`

## üìã √âTAT ACTUEL - CE QUI EXISTE

### ‚úÖ TABLES AVEC AUDIT COMPLET (15 tables)
- **abonnement_stripe** ‚úÖ 2 triggers (CREATE + UPDATE)
- **agence_independante** ‚úÖ 2 triggers (CREATE + UPDATE)
- **agence_independante_collaborateur** ‚úÖ 2 triggers (CREATE + UPDATE)
- **agence_independante_responsable** ‚úÖ 2 triggers (CREATE + UPDATE)
- **brevo_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)
- **facebook_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)
- **instagram_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)
- **linkedin_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)
- **openai_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)
- **reseau** ‚úÖ 2 triggers (CREATE + UPDATE)
- **reseau_agence** ‚úÖ 2 triggers (CREATE + UPDATE)
- **reseau_agence_collaborateur** ‚úÖ 2 triggers (CREATE + UPDATE)
- **reseau_agence_responsable** ‚úÖ 2 triggers (CREATE + UPDATE)
- **reseau_direction** ‚úÖ 2 triggers (CREATE + UPDATE)
- **zoho_connexion** ‚úÖ 2 triggers (CREATE + UPDATE)

### ‚ùå TABLES SANS AUDIT - PROBL√àME CRITIQUE (3 tables)

#### 1. Table `organisations` üî¥ CRITIQUE
**Pourquoi critique :**
- Table multi-tenant principale
- Contient donn√©es de facturation (SIRET, adresses)
- Modifications d'abonnement non trac√©es
- Compliance RGPD manquante

**Colonnes sensibles √† auditer :**
- `organisation_plan_stripe` (changements d'abonnement)
- `organisation_statut_compte` (activation/d√©sactivation)
- `organisation_statut_paiement` (√©tats financiers)
- `organisation_siret` (donn√©es l√©gales)
- `organisation_adresse`, `organisation_ville` (facturation)

#### 2. Table `users` üü° MOYEN
**Pourquoi important :**
- Table d'authentification principale
- Changements de r√¥les syst√®me critiques
- Liens organisation non trac√©s

**Colonnes sensibles √† auditer :**
- `users_role_systeme` (√©l√©vation privil√®ges)
- `users_organisation_id` (changements d'affectation)
- `users_role` (modifications permissions)

#### 3. Table `utilisateurs` üü° MOYEN
**Pourquoi important :**
- Profils m√©tier utilisateurs
- Changements de statut et type compte

**Colonnes sensibles √† auditer :**
- `utilisateur_statut` (activation/d√©sactivation)
- `utilisateur_type_compte` (changements profil)
- `utilisateur_role_systeme` (permissions)

---

## üéØ CE QU'IL FAUT FAIRE - ACTIONS REQUISES

### √âTAPE 1 : Cr√©er les fonctions audit manquantes

#### A. Pour table `organisations`
```sql
-- Fonction CREATE
CREATE OR REPLACE FUNCTION public.set_created_audit_fields_organisations()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.organisation_created_at := now();
  NEW.organisation_created_by := auth.uid();
  NEW.organisation_updated_at := now();
  NEW.organisation_updated_by := auth.uid();
  RETURN NEW;
END;
$function$

-- Fonction UPDATE
CREATE OR REPLACE FUNCTION public.update_audit_fields_organisations()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.organisation_updated_at := now();
  NEW.organisation_updated_by := auth.uid();
  RETURN NEW;
END;
$function$
```

#### B. Pour table `users`
```sql
-- Fonction CREATE
CREATE OR REPLACE FUNCTION public.set_created_audit_fields_users()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.users_updated_at := now();
  NEW.users_updated_by := auth.uid();
  RETURN NEW;
END;
$function$

-- Fonction UPDATE
CREATE OR REPLACE FUNCTION public.update_audit_fields_users()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.users_updated_at := now();
  NEW.users_updated_by := auth.uid();
  RETURN NEW;
END;
$function$
```

#### C. Pour table `utilisateurs`
```sql
-- Fonction CREATE
CREATE OR REPLACE FUNCTION public.set_created_audit_fields_utilisateurs()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.utilisateur_created_at := now();
  NEW.utilisateur_created_by := auth.uid();
  NEW.utilisateur_updated_at := now();
  NEW.utilisateur_updated_by := auth.uid();
  RETURN NEW;
END;
$function$

-- Fonction UPDATE
CREATE OR REPLACE FUNCTION public.update_audit_fields_utilisateurs()
RETURNS trigger
LANGUAGE plpgsql
SET search_path TO 'public'
AS $function$
BEGIN
  NEW.utilisateur_updated_at := now();
  NEW.utilisateur_updated_by := auth.uid();
  RETURN NEW;
END;
$function$
```

### √âTAPE 2 : Cr√©er les triggers manquants

#### A. Triggers pour `organisations`
```sql
-- Trigger CREATE
CREATE TRIGGER set_created_audit_fields_organisations_trigger
  BEFORE INSERT ON public.organisations
  FOR EACH ROW
  EXECUTE FUNCTION public.set_created_audit_fields_organisations();

-- Trigger UPDATE
CREATE TRIGGER update_audit_fields_organisations_trigger
  BEFORE UPDATE ON public.organisations
  FOR EACH ROW
  EXECUTE FUNCTION public.update_audit_fields_organisations();
```

#### B. Triggers pour `users`
```sql
-- Trigger UPDATE (pas de CREATE car g√©r√© par handle_new_user)
CREATE TRIGGER update_audit_fields_users_trigger
  BEFORE UPDATE ON public.users
  FOR EACH ROW
  EXECUTE FUNCTION public.update_audit_fields_users();
```

#### C. Triggers pour `utilisateurs`
```sql
-- Trigger CREATE
CREATE TRIGGER set_created_audit_fields_utilisateurs_trigger
  BEFORE INSERT ON public.utilisateurs
  FOR EACH ROW
  EXECUTE FUNCTION public.set_created_audit_fields_utilisateurs();

-- Trigger UPDATE
CREATE TRIGGER update_audit_fields_utilisateurs_trigger
  BEFORE UPDATE ON public.utilisateurs
  FOR EACH ROW
  EXECUTE FUNCTION public.update_audit_fields_utilisateurs();
```

### √âTAPE 3 : Ajouter colonnes audit manquantes (si n√©cessaire)

**V√©rifier si ces colonnes existent :**
- `organisations` : `organisation_created_at`, `organisation_created_by`, `organisation_updated_at`, `organisation_updated_by`
- `users` : `users_updated_at`, `users_updated_by`
- `utilisateurs` : `utilisateur_created_at`, `utilisateur_created_by`, `utilisateur_updated_at`, `utilisateur_updated_by`

**Si manquantes, les ajouter :**
```sql
-- Exemple pour organisations
ALTER TABLE public.organisations 
ADD COLUMN IF NOT EXISTS organisation_created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN IF NOT EXISTS organisation_created_by UUID,
ADD COLUMN IF NOT EXISTS organisation_updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN IF NOT EXISTS organisation_updated_by UUID;
```

---

## üö® IMPACT BUSINESS DE CE PROBL√àME

### COMPLIANCE & L√âGAL
- ‚ùå **Violation RGPD** : Pas de tra√ßabilit√© des modifications donn√©es personnelles
- ‚ùå **Audit financier** : Aucune trace des changements d'abonnement/facturation
- ‚ùå **S√©curit√©** : Impossible de d√©tecter modifications non autoris√©es

### OPERATIONAL
- ‚ùå **Debug impossible** : Pas d'historique des changements critiques
- ‚ùå **Support client** : Impossible d'expliquer pourquoi donn√©es ont chang√©
- ‚ùå **Monitoring** : Pas d'alerte sur modifications sensibles

---

## ‚úÖ R√âSULTAT ATTENDU APR√àS CORRECTION

### Tra√ßabilit√© compl√®te
- ‚úÖ Toutes les modifications sont logg√©es dans `1_historique_supabase`
- ‚úÖ Qui a fait quoi et quand sur toutes les tables critiques
- ‚úÖ Historique des changements d'abonnement et permissions

### Compliance
- ‚úÖ Respect RGPD avec audit trail complet
- ‚úÖ Tra√ßabilit√© l√©gale des donn√©es financi√®res
- ‚úÖ D√©tection des acc√®s non autoris√©s

### Score s√©curit√©
- **Avant** : 85/100 (audit incomplet)
- **Apr√®s** : 98/100 (audit complet)