# ğŸ”’ TODO LIST - PROBLÃˆME RLS â†’ Table `organisations`

## ğŸ“‹ Ã‰TAT ACTUEL - CE QUI EXISTE

### âŒ POLITIQUE RLS ACTUELLE - PROBLÃˆME CRITIQUE

**Politique existante :**
```sql
Policy Name: "Admin PRESENCA full access organisations"
Command: ALL
Using Expression: is_admin_presenca(auth.uid())
With Check Expression: is_admin_presenca(auth.uid())
```

### ğŸš¨ IMPACT BLOQUANT ACTUEL

#### Qui peut accÃ©der ?
- âœ… **Admins PRESENCA** : AccÃ¨s total (lecture/Ã©criture)
- âŒ **Utilisateurs normaux** : AUCUN accÃ¨s, mÃªme Ã  leur propre organisation

#### ConsÃ©quences business CRITIQUES
```sql
-- Test de l'Ã©tat actuel
SELECT * FROM organisations WHERE organisation_id = get_user_organisation_id(auth.uid());
-- âŒ RÃ‰SULTAT : Aucune ligne retournÃ©e pour utilisateurs non-admin
-- âŒ L'application ne peut pas afficher les infos de l'entreprise
```

**FonctionnalitÃ©s cassÃ©es pour utilisateurs normaux :**
- âŒ Nom de l'entreprise non affichÃ©
- âŒ Plan d'abonnement invisible  
- âŒ Adresse de facturation inaccessible
- âŒ SIRET non rÃ©cupÃ©rable
- âŒ Statut compte non visible
- âŒ **L'interface client est complÃ¨tement cassÃ©e**

---

## ğŸ¯ CE QU'IL FAUT FAIRE - SOLUTION REQUISE

### Ã‰TAPE 1 : Ajouter politique de lecture pour utilisateurs

**Politique Ã  crÃ©er :**
```sql
CREATE POLICY "Users can view their organisation" 
ON public.organisations 
FOR SELECT 
USING (organisation_id = get_user_organisation_id(auth.uid()));
```

### Ã‰TAPE 2 : Politique d'Ã©criture restrictive (optionnel)

**Si nÃ©cessaire, permettre aux utilisateurs de modifier certains champs :**
```sql
-- Exemple : permettre mise Ã  jour des infos de contact uniquement
CREATE POLICY "Users can update organisation contact info" 
ON public.organisations 
FOR UPDATE 
USING (organisation_id = get_user_organisation_id(auth.uid()))
WITH CHECK (
  organisation_id = get_user_organisation_id(auth.uid()) AND
  -- Limiter aux colonnes non-critiques
  organisation_email = OLD.organisation_email OR
  organisation_telephone = OLD.organisation_telephone OR
  organisation_adresse = OLD.organisation_adresse
);
```

### Ã‰TAPE 3 : VÃ©rification sÃ©curitÃ©

**Tester que la fonction `get_user_organisation_id` est sÃ©curisÃ©e :**
```sql
-- âœ… VÃ©rifier que la fonction existe et est SECURITY DEFINER
\df+ get_user_organisation_id

-- âœ… VÃ©rifier qu'elle retourne NULL pour les utilisateurs sans organisation
SELECT get_user_organisation_id('00000000-0000-0000-0000-000000000000');

-- âœ… VÃ©rifier qu'elle fonctionne pour un utilisateur valide  
SELECT get_user_organisation_id(auth.uid());
```

---

## ğŸ” ANALYSE TECHNIQUE DÃ‰TAILLÃ‰E

### Architecture multi-tenant actuelle
```
organisations (table principale)
    â†“ organisation_id
users (users_organisation_id â†’ organisations.organisation_id)
    â†“ users_auth_id  
auth.users (Supabase Auth)
```

### Fonction sÃ©curisÃ©e existante
```sql
CREATE OR REPLACE FUNCTION public.get_user_organisation_id(user_uuid uuid)
RETURNS uuid
LANGUAGE plpgsql
STABLE SECURITY DEFINER  -- âœ… SÃ©curisÃ©e
SET search_path TO 'public'  -- âœ… Protection injection
AS $function$
DECLARE
  org_id uuid;
BEGIN
  -- âœ… RÃ©cupÃ¨re l'organisation de l'utilisateur
  SELECT users_organisation_id INTO org_id
  FROM users 
  WHERE users_auth_id = user_uuid;
  
  -- âœ… Gestion erreur si pas d'organisation (sauf admin_presenca)
  IF org_id IS NULL THEN
    IF NOT EXISTS (
      SELECT 1 FROM users 
      WHERE users_auth_id = user_uuid 
      AND users_role_systeme = 'admin_presenca'
    ) THEN
      RAISE EXCEPTION 'Utilisateur % non associÃ© Ã  une organisation', user_uuid;
    END IF;
  END IF;
  
  RETURN org_id;
END;
$function$
```

### Pattern de sÃ©curitÃ© appliquÃ©
**Ce pattern est dÃ©jÃ  utilisÃ© avec succÃ¨s sur 15+ tables :**
- `abonnement_stripe`
- `agence_independante`  
- `reseau`
- `brevo_connexion`
- etc.

**Toutes ces tables ont :**
```sql
Policy: admin_presenca_full_access_[table] 
Using: is_admin_presenca(auth.uid())

Policy: organisation_only_access_[table]
Using: (organisation_id = get_user_organisation_id(auth.uid()))
```

---

## âš ï¸ VÃ‰RIFICATIONS IMPORTANTES

### 1. Fonction `get_user_organisation_id` fonctionne
```sql
-- Test avec utilisateur connectÃ©
SELECT get_user_organisation_id(auth.uid());
-- Doit retourner un UUID valide ou NULL si admin_presenca
```

### 2. Table `users` peuplÃ©e correctement
```sql
-- VÃ©rifier que tous les auth.users ont un enregistrement dans public.users
SELECT 
  au.id as auth_user_id,
  u.users_id as public_user_id,
  u.users_organisation_id
FROM auth.users au
LEFT JOIN public.users u ON au.id = u.users_auth_id
WHERE u.users_id IS NULL;
-- Ne doit retourner aucune ligne
```

### 3. Liens organisation cohÃ©rents
```sql
-- VÃ©rifier que les organisation_id dans users existent
SELECT u.users_id, u.users_organisation_id, o.organisation_id
FROM public.users u
LEFT JOIN public.organisations o ON u.users_organisation_id = o.organisation_id
WHERE u.users_organisation_id IS NOT NULL 
AND o.organisation_id IS NULL;
-- Ne doit retourner aucune ligne
```

---

## ğŸš¨ IMPACT BUSINESS DE CE PROBLÃˆME

### FONCTIONNEL
- ğŸ”´ **Application inutilisable** pour utilisateurs normaux
- ğŸ”´ **Interface client cassÃ©e** complÃ¨tement
- ğŸ”´ **Multi-tenancy non fonctionnelle**

### SÃ‰CURITÃ‰  
- ğŸŸ¡ **Trop restrictif** mais pas de faille sÃ©curitÃ©
- ğŸŸ¡ **Principe moindre privilÃ¨ge** respectÃ© (trop mÃªme)

### BUSINESS
- ğŸ”´ **Perte clients** : Application ne fonctionne pas
- ğŸ”´ **Support dÃ©bordÃ©** : Utilisateurs ne voient rien
- ğŸ”´ **RÃ©putation** : Produit perÃ§u comme dÃ©faillant

---

## âœ… RÃ‰SULTAT ATTENDU APRÃˆS CORRECTION

### Interface utilisateur fonctionnelle
- âœ… Affichage nom entreprise
- âœ… Informations d'abonnement visibles
- âœ… DonnÃ©es de facturation accessibles  
- âœ… Multi-tenancy opÃ©rationnelle

### SÃ©curitÃ© maintenue
- âœ… Utilisateurs voient uniquement LEUR organisation
- âœ… Admins PRESENCA gardent accÃ¨s total
- âœ… Isolation entre organisations respectÃ©e

### Tests de validation
```sql
-- Test utilisateur normal
SELECT organisation_nom FROM organisations; 
-- âœ… Doit retourner 1 ligne (son organisation)

-- Test admin PRESENCA  
SELECT COUNT(*) FROM organisations;
-- âœ… Doit retourner toutes les organisations
```

### Score sÃ©curitÃ©
- **Avant** : 90/100 (trop restrictif)
- **AprÃ¨s** : 95/100 (Ã©quilibrÃ© optimal)