 TODO — Migration de localStorage → Table admin_sessions
Contexte actuel
Le contexte d’impersonation (ImpersonationContext.tsx) stocke l’organisation_id impersonifiée dans le localStorage du navigateur :

ts
Copier
Modifier
localStorage.setItem('impersonated_organisation_id', organisation.organisation_id);
Cela permet :

De retenir l’état d’impersonation même après un rechargement de page.

D’assurer une expérience fluide pour l’admin pendant toute sa session.

De garder une solution simple et sans backend dédié pendant la phase de développement.

Pourquoi c’est OK maintenant
✅ Phase actuelle = Dev / Test interne

Utilisateurs : uniquement les administrateurs admin_presenca.

Données stockées : uniquement un identifiant d’organisation (uuid), pas d’informations sensibles.

Objectif : simplicité et rapidité d’implémentation.

✅ Sécurité assurée côté Supabase

Toutes les requêtes passent par useSupabaseOperations → RLS toujours appliquée.

L’ID dans le localStorage ne donne pas d’accès direct : il faut être authentifié et avoir le rôle admin_presenca.

Limites de localStorage
⚠️ Stockage côté navigateur

Non partagé entre appareils ou navigateurs.

Non synchronisé si l’admin change de poste.

Pas de gestion de session avancée (expiration, logs).

⚠️ Pas de suivi serveur

Impossible de savoir côté backend qui a impersonifié qui et quand.

Pas de journal d’audit centralisé.

Plan de migration — V2
Quand l’application sera en production ou ouverte à plus d’utilisateurs :

Créer une table admin_sessions :

sql
Copier
Modifier
CREATE TABLE admin_sessions (
  session_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_user_id uuid NOT NULL REFERENCES users(users_auth_id),
  impersonated_org_id uuid REFERENCES organisations(organisation_id),
  started_at timestamptz DEFAULT now(),
  expires_at timestamptz
);
Stocker les impersonations côté serveur via useSupabaseOperations :

Lors du startImpersonation, insérer une ligne dans admin_sessions.

Récupérer la session active au chargement au lieu de lire le localStorage.

Avantages de cette migration :

Synchronisation entre appareils.

Expiration automatique des sessions.

Historique complet pour l’audit (log_audit_event).

Possibilité de supervision côté admin global.

Conclusion
Pour l’instant → on garde localStorage car :

C’est simple.

Suffisant pour l’usage interne.

Ne compromet pas la sécurité RLS.

En V2 → migrer vers admin_sessions pour :

Améliorer la traçabilité.

Gérer les sessions multi-appareils.

Renforcer la cohérence backend.
