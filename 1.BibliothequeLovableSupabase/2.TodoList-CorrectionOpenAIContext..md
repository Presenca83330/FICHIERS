# TODO ‚Äî Migration OpenAIContext ‚Üí Tables Supabase s√©curis√©es

## Contexte actuel CRITIQUE ‚ö†Ô∏è

Le contexte OpenAI (`OpenAIContext.tsx`) expose actuellement des **cl√©s API OpenAI en dur** dans le code :

```typescript
const DEFAULT_API_KEY = "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";
const DEFAULT_ASSISTANT_ID = "asst_8Yi0FYcWUr5pMAeKT4FxPxUi";
const DEFAULT_ZONE_API_KEY = "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";
const DEFAULT_ZONE_ASSISTANT_ID = "asst_rtj3ETrVwO083A1M6P5T9YNb";
```

## Probl√®mes de s√©curit√© MAJEURS üö®

### ‚ùå Exposition des cl√©s API
- **Cl√©s OpenAI visibles** dans le code source
- **Accessible** √† tous les utilisateurs du navigateur
- **Compromission** des comptes OpenAI
- **Violation** des bonnes pratiques de s√©curit√©

### ‚ùå Stockage localStorage non s√©curis√©
- Cl√©s API stock√©es en localStorage c√¥t√© client
- Aucun chiffrement des donn√©es sensibles
- Persistance non contr√¥l√©e des secrets

### ‚ùå Pas de gestion des permissions
- Aucun contr√¥le d'acc√®s aux cl√©s API
- Pas de limitation par organisation/utilisateur
- Pas de rotation des cl√©s

## Plan de migration URGENT ‚Äî V2

### 1. Cr√©er table `openai_connexion` s√©curis√©e

Utiliser la structure d√©finie dans :
`src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/6-DOCS-TABLES-UTILISEES/3.TABLES-CONNEXION-MIGRATION/05.TABLE CONNEXION - openai_connexion.csv`

```sql
CREATE TABLE openai_connexion (
  openai_connexion_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organisation_id uuid NOT NULL REFERENCES organisations(organisation_id),
  client_type text NOT NULL CHECK (client_type IN ('reseau', 'agence_independante')),
  openai_api_key text, -- Chiffr√© c√¥t√© serveur
  openai_assistant_id text,
  openai_zone_api_key text, -- Chiffr√© c√¥t√© serveur  
  openai_zone_assistant_id text,
  openai_statut_connexion text DEFAULT 'inactive',
  openai_date_derniere_synchro timestamptz,
  -- Audit et s√©curit√©
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by_user_id uuid REFERENCES users(users_auth_id),
  updated_by_user_id uuid REFERENCES users(users_auth_id)
);
```

### 2. Politiques RLS strictes

```sql
-- Seuls les admins PRESENCA peuvent g√©rer les connexions OpenAI
CREATE POLICY "Admin PRESENCA peut g√©rer openai_connexion"
ON openai_connexion
FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM users 
    WHERE users.users_auth_id = auth.uid() 
    AND users.users_role_systeme = 'admin_presenca'
  )
);

-- Les organisations peuvent voir leur propre connexion
CREATE POLICY "Organisation peut voir sa connexion OpenAI"
ON openai_connexion
FOR SELECT
USING (
  organisation_id IN (
    SELECT users.users_organisation_id 
    FROM users 
    WHERE users.users_auth_id = auth.uid()
  )
);
```

### 3. Edge Function pour chiffrement

Cr√©er `supabase/functions/openai-key-manager/index.ts` :

```typescript
// Chiffrement/d√©chiffrement s√©curis√© des cl√©s API
// Validation des cl√©s OpenAI avant stockage
// Logs d'audit pour chaque utilisation
```

### 4. Nouveau hook s√©curis√©

Remplacer `useOpenAI` par `useSecureOpenAI` :

```typescript
// R√©cup√©ration depuis openai_connexion via RLS
// Gestion du cache s√©curis√© (pas localStorage)
// Validation automatique des cl√©s
// Int√©gration avec useSupabaseOperations
```

## Actions prioritaires

### Phase 1 : CRITIQUE (Imm√©diat)
- [ ] **SUPPRIMER** les cl√©s API du code source
- [ ] Cr√©er table `openai_connexion` avec RLS
- [ ] Impl√©menter edge function de chiffrement
- [ ] Migrer vers stockage s√©curis√© Supabase

### Phase 2 : S√©curisation (Urgent)
- [ ] Nouveau hook `useSecureOpenAI`
- [ ] Interface admin pour gestion des cl√©s
- [ ] Validation automatique des cl√©s API
- [ ] Logs d'audit des utilisations

### Phase 3 : Am√©lioration (Important)
- [ ] Rotation automatique des cl√©s
- [ ] Monitoring d'usage OpenAI
- [ ] Alertes de s√©curit√©
- [ ] Backup/restore des configurations

## Avantages post-migration

‚úÖ **S√©curit√© renforc√©e**
- Cl√©s API chiffr√©es c√¥t√© serveur
- Acc√®s contr√¥l√© par RLS
- Audit complet des utilisations

‚úÖ **Gestion centralis√©e**
- Configuration par organisation
- Interface admin d√©di√©e
- Synchronisation multi-appareils

‚úÖ **Monitoring avanc√©**
- Suivi de l'usage OpenAI
- D√©tection d'anomalies
- Optimisation des co√ªts

## √âtat actuel : DANGER üö®

**Score s√©curit√© : 1/10**
- Cl√©s API expos√©es publiquement
- Aucun contr√¥le d'acc√®s
- Risque de compromission √©lev√©

**Action requise : IMM√âDIATE**

La migration doit √™tre effectu√©e **avant toute mise en production** pour √©viter une faille de s√©curit√© majeure.

---

## ‚úÖ STATUT ACTUEL ‚Äî 11/08/2025

**üîç PROBL√àME IDENTIFI√â ET DOCUMENT√â**
- ‚úÖ Audit de s√©curit√© complet effectu√©
- ‚úÖ Documentation technique d√©taill√©e
- ‚úÖ Plan de migration d√©fini √©tape par √©tape
- ‚úÖ Priorit√©s √©tablies (Phase 1, 2, 3)

**üìã TODO LIST ACTIVE**
- üîÑ **EN ATTENTE** : Migration vers table `openai_connexion` s√©curis√©e
- üîÑ **EN ATTENTE** : Suppression des cl√©s API en dur du code
- üîÑ **EN ATTENTE** : Impl√©mentation Edge Function chiffrement
- üîÑ **EN ATTENTE** : Nouveau hook `useSecureOpenAI`

**üìù NOTE √âQUIPE**
Ce point critique est **parfaitement identifi√©** et sera trait√© dans les prochaines phases du projet. Le plan d√©taill√© ci-dessus garantit une correction m√©thodique et s√©curis√©e.