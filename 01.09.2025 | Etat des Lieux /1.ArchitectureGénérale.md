# Architecture Visuelle LeadgenAI - √âtat Actuel

## 1. VUE D'ENSEMBLE SYST√àME

```mermaid
graph TB
    %% Couche Pr√©sentation
    subgraph "üñ•Ô∏è INTERFACES UTILISATEUR"
        WEB[Interface Web React]
        AUTH[Authentification Google]
        DASH[Dashboard Multi-tenant]
    end

    %% Couche Application
    subgraph "‚ö° COUCHE APPLICATION"
        API[Supabase API]
        RPC[Fonctions RPC]
        HOOKS[Hooks Strat√©giques]
        MULTITENANT[useMultiTenant]
        CURRENTUSER[useCurrentUser]
    end

    %% Couche Donn√©es
    subgraph "üóÑÔ∏è BASE DE DONN√âES SUPABASE"
        ORGS[organisations]
        USERS[users/utilisateurs]
        CLIENTS[Tables Clients]
        CONN[Tables Connexions]
        HIST[Historique]
    end

    %% Couche Int√©grations
    subgraph "üîó INT√âGRATIONS EXTERNES"
        OPENAI[OpenAI API]
        BREVO[Brevo Email]
        LINKEDIN[LinkedIn]
        FACEBOOK[Facebook]
        INSTAGRAM[Instagram]
        ZOHO[Zoho CRM]
        STRIPE[Stripe Paiements]
    end

    %% Connexions principales
    WEB --> API
    AUTH --> API
    DASH --> HOOKS
    HOOKS --> API
    API --> ORGS
    API --> USERS
    API --> CLIENTS
    API --> CONN
    CONN --> OPENAI
    CONN --> BREVO
    CONN --> LINKEDIN
    CONN --> FACEBOOK
    CONN --> INSTAGRAM
    CONN --> ZOHO
    STRIPE --> HIST

    %% Styles
    classDef interface fill:#e1f5fe
    classDef application fill:#f3e5f5
    classDef database fill:#e8f5e8
    classDef integration fill:#fff3e0
    
    class WEB,AUTH,DASH interface
    class API,RPC,HOOKS,MULTITENANT,CURRENTUSER application
    class ORGS,USERS,CLIENTS,CONN,HIST database
    class OPENAI,BREVO,LINKEDIN,FACEBOOK,INSTAGRAM,ZOHO,STRIPE integration
```

## 2. ARCHITECTURE MULTI-TENANT

```mermaid
graph TD
    %% Niveau Organisation
    subgraph "üè¢ NIVEAU ORGANISATION"
        ORG[Organisation]
        ORGID[organisation_id]
    end

    %% Types de clients
    subgraph "üë• TYPES DE CLIENTS"
        PRESENCA[PRESENCA<br/>Admin Syst√®me]
        RESEAU[RESEAU<br/>R√©seau d'agences]
        AGENCE_INDEP[AGENCE IND√âPENDANTE<br/>Agence autonome]
    end

    %% Structure R√©seau
    subgraph "üèóÔ∏è STRUCTURE R√âSEAU"
        RESEAU_DIR[reseau_direction]
        RESEAU_AG[reseau_agence]
        RESEAU_AG_RESP[reseau_agence_responsable]
        RESEAU_AG_COLLAB[reseau_agence_collaborateur]
    end

    %% Structure Agence Ind√©pendante
    subgraph "üè™ STRUCTURE AGENCE IND√âPENDANTE"
        AGENCE[agence_independante]
        AGENCE_RESP[agence_independante_responsable]
        AGENCE_COLLAB[agence_independante_collaborateur]
    end

    %% Connexions
    ORG --> ORGID
    ORGID --> PRESENCA
    ORGID --> RESEAU
    ORGID --> AGENCE_INDEP
    
    RESEAU --> RESEAU_DIR
    RESEAU --> RESEAU_AG
    RESEAU_AG --> RESEAU_AG_RESP
    RESEAU_AG --> RESEAU_AG_COLLAB
    
    AGENCE_INDEP --> AGENCE_RESP
    AGENCE_INDEP --> AGENCE_COLLAB

    %% Styles
    classDef org fill:#ffecb3
    classDef tenant fill:#c8e6c9
    classDef structure fill:#e1bee7
    
    class ORG,ORGID org
    class PRESENCA,RESEAU,AGENCE_INDEP tenant
    class RESEAU_DIR,RESEAU_AG,RESEAU_AG_RESP,RESEAU_AG_COLLAB,AGENCE,AGENCE_RESP,AGENCE_COLLAB structure
```

## 3. ARCHITECTURE BASE DE DONN√âES

```mermaid
erDiagram
    %% Tables principales
    organisations {
        uuid organisation_id PK
        text organisation_nom
        text organisation_email
        text organisation_siret
        text organisation_statut_compte
    }

    users {
        uuid users_id PK
        uuid users_auth_id FK
        text users_nom
        text users_prenom
        text users_email
        text users_role
        text users_role_systeme
        uuid users_organisation_id FK
    }

    %% Tables clients
    reseau {
        uuid reseau_id PK
        uuid organisation_id FK
        uuid client_id
        text reseau_nom
        text reseau_statut
    }

    agence_independante {
        uuid agence_indep_id PK
        uuid organisation_id FK
        uuid client_id
        text agence_indep_nom
        text agence_indep_statut
    }

    %% Tables connexions
    openai_connexion {
        uuid openai_connexion_id PK
        uuid organisation_id FK
        uuid client_id FK
        text openai_api_key
        boolean openai_actif
    }

    brevo_connexion {
        uuid brevo_connexion_id PK
        uuid organisation_id FK
        uuid client_id FK
        text brevo_api_key
        boolean brevo_actif
    }

    %% Tables historique
    "1_historique_supabase" {
        uuid audit_log_id PK
        uuid organisation_id FK
        text historique_operation
        jsonb historique_old_data
        jsonb historique_new_data
    }

    %% Relations
    organisations ||--o{ users : "organisation_id"
    organisations ||--o{ reseau : "organisation_id"
    organisations ||--o{ agence_independante : "organisation_id"
    organisations ||--o{ openai_connexion : "organisation_id"
    organisations ||--o{ brevo_connexion : "organisation_id"
    organisations ||--o{ "1_historique_supabase" : "organisation_id"
```

## 4. FLUX D'AUTHENTIFICATION ACTUEL

```mermaid
sequenceDiagram
    participant U as Utilisateur
    participant G as Google Auth
    participant S as Supabase Auth
    participant DB as Base de Donn√©es
    participant H as useCurrentUser
    participant MT as useMultiTenant

    U->>G: 1. Connexion Google
    G->>S: 2. Token Google
    S->>S: 3. Cr√©ation/Validation auth.users
    S->>DB: 4. Requ√™te users par auth_id
    DB->>S: 5. Donn√©es utilisateur
    S->>H: 6. Chargement profil utilisateur
    H->>DB: 7. RPC get_current_user_organisation
    DB->>H: 8. Donn√©es organisation
    H->>MT: 9. Initialisation contexte tenant
    MT->>MT: 10. Calcul permissions & r√¥les
    MT->>U: 11. Interface adapt√©e au tenant

    Note over U,MT: Flux complet d'authentification multi-tenant
```

## 5. S√âCURIT√â RLS (Row Level Security)

```mermaid
graph LR
    %% Utilisateurs
    subgraph "üë§ UTILISATEURS"
        USER[Utilisateur]
        AUTH_UID[auth.uid()]
    end

    %% Fonctions de s√©curit√©
    subgraph "üîê FONCTIONS S√âCURIT√â"
        IS_ADMIN[is_admin_presenca()]
        GET_ORG[get_user_organisation_id()]
    end

    %% Politiques RLS
    subgraph "üõ°Ô∏è POLITIQUES RLS"
        ADMIN_FULL[Admin PRESENCA<br/>Acc√®s total]
        ORG_SCOPE[Acc√®s limit√©<br/>√† l'organisation]
        USER_SCOPE[Acc√®s limit√©<br/>aux donn√©es utilisateur]
    end

    %% Tables avec RLS
    subgraph "üìä TABLES PROT√âG√âES"
        ORGS_T[organisations]
        USERS_T[users]
        CLIENTS_T[Tables clients]
        CONN_T[Tables connexions]
        HIST_T[Historique]
    end

    %% Flux de s√©curit√©
    USER --> AUTH_UID
    AUTH_UID --> IS_ADMIN
    AUTH_UID --> GET_ORG
    
    IS_ADMIN --> ADMIN_FULL
    GET_ORG --> ORG_SCOPE
    AUTH_UID --> USER_SCOPE
    
    ADMIN_FULL --> ORGS_T
    ADMIN_FULL --> USERS_T
    ADMIN_FULL --> CLIENTS_T
    ADMIN_FULL --> CONN_T
    ADMIN_FULL --> HIST_T
    
    ORG_SCOPE --> CLIENTS_T
    ORG_SCOPE --> CONN_T
    ORG_SCOPE --> HIST_T
    
    USER_SCOPE --> USERS_T

    %% Styles
    classDef user fill:#e3f2fd
    classDef security fill:#fff3e0
    classDef policy fill:#e8f5e8
    classDef table fill:#fce4ec
    
    class USER,AUTH_UID user
    class IS_ADMIN,GET_ORG security
    class ADMIN_FULL,ORG_SCOPE,USER_SCOPE policy
    class ORGS_T,USERS_T,CLIENTS_T,CONN_T,HIST_T table
```

## 6. INTERFACES UTILISATEUR

```mermaid
graph TB
    %% Point d'entr√©e
    subgraph "üö™ AUTHENTIFICATION"
        LOGIN[Page de connexion]
        GOOGLE_BTN[Bouton Google Auth]
    end

    %% Hooks strat√©giques
    subgraph "‚ö° HOOKS STRAT√âGIQUES"
        USE_AUTH[useAuth]
        USE_CURRENT[useCurrentUser]
        USE_TENANT[useMultiTenant]
    end

    %% Interfaces par type
    subgraph "üëë INTERFACE ADMIN PRESENCA"
        ADMIN_DASH[Dashboard Admin]
        ORG_MGMT[Gestion Organisations]
        USER_MGMT[Gestion Utilisateurs]
        SYSTEM_MONITOR[Monitoring Syst√®me]
    end

    subgraph "üè¢ INTERFACE R√âSEAU"
        RESEAU_DASH[Dashboard R√©seau]
        AGENCE_LIST[Liste Agences]
        STATS_RESEAU[Statistiques R√©seau]
    end

    subgraph "üè™ INTERFACE AGENCE"
        AGENCE_DASH[Dashboard Agence]
        LEAD_MGMT[Gestion Leads]
        CAMPAIGN_MGMT[Gestion Campagnes]
        CONN_SETUP[Configuration Connexions]
    end

    %% Flux de navigation
    LOGIN --> GOOGLE_BTN
    GOOGLE_BTN --> USE_AUTH
    USE_AUTH --> USE_CURRENT
    USE_CURRENT --> USE_TENANT
    
    USE_TENANT --> ADMIN_DASH
    USE_TENANT --> RESEAU_DASH
    USE_TENANT --> AGENCE_DASH
    
    ADMIN_DASH --> ORG_MGMT
    ADMIN_DASH --> USER_MGMT
    ADMIN_DASH --> SYSTEM_MONITOR
    
    RESEAU_DASH --> AGENCE_LIST
    RESEAU_DASH --> STATS_RESEAU
    
    AGENCE_DASH --> LEAD_MGMT
    AGENCE_DASH --> CAMPAIGN_MGMT
    AGENCE_DASH --> CONN_SETUP

    %% Styles
    classDef auth fill:#e8eaf6
    classDef hooks fill:#f3e5f5
    classDef admin fill:#e8f5e8
    classDef reseau fill:#e1f5fe
    classDef agence fill:#fff3e0
    
    class LOGIN,GOOGLE_BTN auth
    class USE_AUTH,USE_CURRENT,USE_TENANT hooks
    class ADMIN_DASH,ORG_MGMT,USER_MGMT,SYSTEM_MONITOR admin
    class RESEAU_DASH,AGENCE_LIST,STATS_RESEAU reseau
    class AGENCE_DASH,LEAD_MGMT,CAMPAIGN_MGMT,CONN_SETUP agence
```

## PROBL√àMES IDENTIFI√âS

### üî¥ Incoh√©rences d√©tect√©es
1. **Duplication tables utilisateurs** : `users` et `utilisateurs`
2. **Fichier Supabase manquant** : Erreur dans `lib/supabase.ts` avec variables Next.js
3. **Hooks non int√©gr√©s** : `useMultiTenant` cr√©√© mais pas utilis√© dans l'interface
4. **RLS complexe** : Politiques multiples sur m√™me table

### üü° Points d'attention
1. **Gestion des r√¥les** : Diff√©rences entre `users_role` et `users_role_systeme`
2. **Organisation ID** : Pas toujours coh√©rent entre tables
3. **Connexions externes** : Multiples APIs avec quotas √† g√©rer

### üìã Actions recommand√©es
1. Fusionner ou clarifier les tables utilisateurs
2. Corriger la configuration Supabase pour Vite
3. Int√©grer les hooks strat√©giques dans l'interface
4. Simplifier les politiques RLS redondantes
