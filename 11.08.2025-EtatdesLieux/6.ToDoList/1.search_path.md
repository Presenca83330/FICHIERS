# CORRECTION SET search_path - fonction sync_users_utilisateurs()

## PROBLÈME IDENTIFIÉ
- **Fonction**: `sync_users_utilisateurs()`
- **Issue**: Manque `SET search_path TO 'public'`
- **Criticité**: Sécurité mineure (dernière alerte linter)

## FONCTION ACTUELLE
```sql
CREATE OR REPLACE FUNCTION public.sync_users_utilisateurs()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Synchronisation users → utilisateurs
  IF TG_TABLE_NAME = 'users' AND TG_OP = 'UPDATE' THEN
    UPDATE public.utilisateurs 
    SET 
      utilisateur_email = NEW.users_email,
      utilisateur_organisation_id = NEW.users_organisation_id
    WHERE utilisateur_auth_uid = NEW.users_auth_id;
  END IF;
  
  -- Synchronisation utilisateurs → users  
  IF TG_TABLE_NAME = 'utilisateurs' AND TG_OP = 'UPDATE' THEN
    UPDATE public.users 
    SET 
      users_email = NEW.utilisateur_email,
      users_organisation_id = NEW.utilisateur_organisation_id
    WHERE users_auth_id = NEW.utilisateur_auth_uid;
  END IF;
  
  RETURN NEW;
END;
$function$
```

## CORRECTION PROPOSÉE
```sql
CREATE OR REPLACE FUNCTION public.sync_users_utilisateurs()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  -- Synchronisation users → utilisateurs
  IF TG_TABLE_NAME = 'users' AND TG_OP = 'UPDATE' THEN
    UPDATE utilisateurs 
    SET 
      utilisateur_email = NEW.users_email,
      utilisateur_organisation_id = NEW.users_organisation_id
    WHERE utilisateur_auth_uid = NEW.users_auth_id;
  END IF;
  
  -- Synchronisation utilisateurs → users  
  IF TG_TABLE_NAME = 'utilisateurs' AND TG_OP = 'UPDATE' THEN
    UPDATE users 
    SET 
      users_email = NEW.utilisateur_email,
      users_organisation_id = NEW.utilisateur_organisation_id
    WHERE users_auth_id = NEW.utilisateur_auth_uid;
  END IF;
  
  RETURN NEW;
END;
$function$
```

## CHANGEMENTS
1. **Ajout**: `SET search_path TO 'public'`
2. **Optimisation**: Suppression préfixes `public.` (devenus redondants)

## IMPACT
- ✅ **Sécurité**: Protection contre injection de schéma
- ✅ **Standards**: Alignement avec les 31 autres fonctions
- ✅ **Linter**: Suppression de la dernière alerte
- ✅ **Performance**: Optimisation légère (moins de résolution)

## CONTEXTE TECHNIQUE
- **Rôle**: Synchronisation bidirectionnelle tables `users` ↔ `utilisateurs`
- **Triggers**: Attachée aux deux tables pour multi-tenant
- **Criticité**: Architecture fondamentale (authentification SaaS)

## STATUT
- [ ] À implémenter via migration Supabase
- [ ] Test validation post-migration
- [ ] Vérification linter (0 warning attendu)

---
**Note**: Correction de 30 secondes pour atteindre score sécurité 100%