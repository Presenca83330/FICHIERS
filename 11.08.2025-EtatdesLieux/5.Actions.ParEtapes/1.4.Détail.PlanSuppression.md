# Plan D√©taill√© de Suppression - organisation_type_structure

## üìã Vue d'ensemble

**Objectif** : Supprimer la colonne organisation_type_structure de la table organisations et la remplacer par une fonction SQL dynamique get_organisation_type().

**Raison** : La colonne contient des donn√©es incoh√©rentes et cause des erreurs dans la logique multi-tenant de l'application.

**Strat√©gie OpenAI** : Bascule compl√®te vers get_organisation_type() AVANT suppression de la colonne pour garantir le fonctionnement imm√©diat.

**Structure Business R√©elle** : Seuls 3 types existent :
- isReseau - Inclut reseau ET reseau_agence (m√™me type business)
- isAgenceIndep - Pour agence_independante
- isPresenca - Via r√¥le syst√®me users_role_systeme = 'admin_presenca'

---

## üóÉÔ∏è PHASE 1 : CR√âATION FONCTION SUPABASE

### 1.1 Cr√©ation de la fonction get_organisation_type()

**Script SQL √† ex√©cuter :**

sql
-- Fonction pour d√©terminer dynamiquement le type d'organisation
-- ALIGN√âE SUR LA VRAIE STRUCTURE BUSINESS (Message OpenAI)
CREATE OR REPLACE FUNCTION public.get_organisation_type(org_id uuid)
RETURNS text
LANGUAGE plpgsql
STABLE SECURITY DEFINER
SET search_path TO 'public'
AS $$
BEGIN
  -- RESEAU : inclut reseau + reseau_agence (m√™me type business)
  IF EXISTS (SELECT 1 FROM reseau WHERE organisation_id = org_id) 
     OR EXISTS (SELECT 1 FROM reseau_agence WHERE organisation_id = org_id) THEN
    RETURN 'reseau';
  END IF;
  
  -- AGENCE INDEPENDANTE : type business distinct
  IF EXISTS (SELECT 1 FROM agence_independante WHERE organisation_id = org_id) THEN
    RETURN 'agence_independante';
  END IF;
  
  -- PRESENCA g√©r√© via r√¥le syst√®me, pas type d'organisation
  RETURN NULL;
END;
$$;


### 1.2 Tests de validation

**Script de test :**

sql
-- Test de la fonction sur quelques organisations
SELECT 
  o.organisation_id,
  o.organisation_nom,
  o.organisation_type_structure as ancien_type,
  get_organisation_type(o.organisation_id) as nouveau_type
FROM organisations o
LIMIT 10;

-- V√©rifier les incoh√©rences (Structure Business R√©elle)
SELECT 
  o.organisation_id,
  o.organisation_nom,
  o.organisation_type_structure as colonne_actuelle,
  get_organisation_type(o.organisation_id) as fonction_calculee,
  CASE 
    WHEN o.organisation_type_structure != get_organisation_type(o.organisation_id) 
    THEN '‚ùå INCOH√âRENT' 
    ELSE '‚úÖ COH√âRENT' 
  END as statut
FROM organisations o
WHERE o.organisation_type_structure IS NOT NULL;


---

## üíª PHASE 2 : BASCULE APPLICATION (STRAT√âGIE OPENAI)

**üéØ Objectif** : Faire basculer l'application vers get_organisation_type() AVANT de supprimer la colonne, pour garantir le fonctionnement imm√©diat.

### 2.1 Modification des queries Supabase

#### **src/integrations/supabase/queries.ts**

**Adaptation pour utiliser la nouvelle fonction :**

typescript
// NOUVELLE APPROCHE : Utiliser calculated_type via la fonction
.select(`
  organisation_id,
  organisation_nom,
  calculated_type:get_organisation_type(organisation_id),
  organisation_type_structure,
  ...autres_champs
`)


**Note :** On garde temporairement organisation_type_structure pour le fallback si n√©cessaire.

### 2.2 Modification du hook principal

#### **src/components/HOOKS-STRATEGIQUE/3.HOOK-useMultiTenant/useMultiTenant.ts**

**Basculer vers la nouvelle logique :**

typescript
// NOUVELLE LOGIQUE ALIGN√âE STRUCTURE BUSINESS OPENAI
organisationType: profile?.users_organisation?.calculated_type || null,

// CLASSIFICATIONS SIMPLIFI√âES - STRUCTURE BUSINESS R√âELLE
const isReseau = organisationType === "reseau";           // inclut reseau + reseau_agence
const isAgenceIndep = organisationType === "agence_independante";
const isPresenca = users_role_systeme === "admin_presenca";  // g√©r√© par r√¥le syst√®me

// SUPPRESSION COMPL√àTE de isAgenceReseau (erreur h√©rit√©e ancienne conception)


### 2.3 Adaptation des helpers

#### **src/integrations/supabase/helpers.ts**

**Nouvelle fonction utilitaire :**

typescript
export const getOrganisationType = (org: Organisation) => {
  // Priorit√© √† la fonction calcul√©e - Structure Business R√©elle
  return org.calculated_type || org.organisation_type_structure || null;
};


---

## üß™ PHASE 3 : TESTS ET VALIDATION

### 3.1 Tests en d√©veloppement

**Validation que l'application fonctionne avec calculated_type :**

typescript
// Dans la console navigateur : v√©rifier que calculated_type est pr√©sent
console.log('Organisation type:', profile?.users_organisation?.calculated_type);

// Tests useMultiTenant ALIGN√â STRUCTURE BUSINESS R√âELLE
const { organisationType, isReseau, isAgenceIndep, isPresenca } = useMultiTenant();
console.log('Types d√©tect√©s:', { organisationType, isReseau, isAgenceIndep, isPresenca });


### 3.2 Validation compl√®te fonctionnement

**Checklist avant suppression - STRUCTURE BUSINESS R√âELLE :**
- ‚úÖ L'application charge sans erreurs
- ‚úÖ useMultiTenant retourne les bons types : isReseau, isAgenceIndep, isPresenca
- ‚úÖ AUCUNE r√©f√©rence √† isAgenceReseau (erreur ancienne conception)
- ‚úÖ Les classifications business fonctionnent correctement
- ‚úÖ Pas d'erreurs TypeScript
- ‚úÖ Pas d'erreurs en console navigateur
- ‚úÖ Les requ√™tes Supabase utilisent bien calculated_type

---

## üîß PHASE 4 : SUPPRESSION FINALE COLONNE

### 4.1 Script de suppression

**Migration SQL :**

sql
-- √âtape 1: Supprimer la contrainte CHECK si elle existe
ALTER TABLE organisations 
DROP CONSTRAINT IF EXISTS check_organisation_type_structure;

-- √âtape 2: Supprimer la colonne
ALTER TABLE organisations 
DROP COLUMN IF EXISTS organisation_type_structure;

-- √âtape 3: Ajouter un commentaire pour documentation
COMMENT ON FUNCTION get_organisation_type(uuid) IS 
'Fonction de remplacement pour organisation_type_structure. 
Calcule dynamiquement le type d''organisation bas√© sur les tables li√©es.
Structure Business : reseau (inclut reseau+reseau_agence) | agence_independante | NULL (PRESENCA via r√¥le)';


### 4.2 V√©rification post-migration

sql
-- V√©rifier que la colonne n'existe plus
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'organisations' 
AND column_name = 'organisation_type_structure';

-- Tester la fonction
SELECT get_organisation_type('uuid-test-organisation');


---

## üìã ORDRE D'EX√âCUTION RECOMMAND√â (STRAT√âGIE OPENAI)

### Phase A : Cr√©ation fonction (sans impact)
1. ‚úÖ Cr√©er la fonction get_organisation_type() dans Supabase
2. ‚úÖ Tester la fonction sur quelques organisations
3. ‚úÖ Valider la coh√©rence des donn√©es

### Phase B : Bascule application (CRITIQUE)
4. ‚úÖ Modifier queries.ts pour utiliser calculated_type:get_organisation_type(organisation_id)
5. ‚úÖ Modifier useMultiTenant.ts pour utiliser calculated_type au lieu de organisation_type_structure
6. ‚úÖ **NETTOYER** toute r√©f√©rence √† isAgenceReseau (erreur ancienne conception)
7. ‚úÖ Adapter helpers.ts avec fallback temporaire
8. ‚úÖ **TESTS COMPLETS** : Valider que tout fonctionne avec la Structure Business R√©elle

### Phase C : Suppression s√©curis√©e (apr√®s validation compl√®te)
9. ‚úÖ Supprimer les r√©f√©rences √† organisation_type_structure du code
10. ‚úÖ Ex√©cuter la migration de suppression de colonne
11. ‚úÖ V√©rifier que les types TypeScript sont mis √† jour
12. ‚úÖ Tests finaux de l'application

---

## üö® POINTS D'ATTENTION

### Risques identifi√©s
- **Downtime potentiel** : La suppression de colonne peut causer une br√®ve interruption
- **Cache TypeScript** : Les types peuvent n√©cessiter une r√©g√©n√©ration
- **D√©pendances cach√©es** : D'autres parties du code pourraient utiliser cette colonne
- **R√©gressions** : Pr√©sence d'isAgenceReseau dans le code (erreur ancienne conception)

### Mesures de s√©curit√©
- **Backup** : Sauvegarder la base avant migration finale
- **Rollback plan** : Pr√©parer un script de restauration si n√©cessaire
- **Tests** : Valider chaque √©tape avant la suivante
- **Audit code** : V√©rifier l'absence compl√®te de r√©f√©rences √† isAgenceReseau

### Validation finale - STRUCTURE BUSINESS R√âELLE
- ‚úÖ useMultiTenant fonctionne correctement
- ‚úÖ Les classifications isReseau, isAgenceIndep, isPresenca sont correctes
- ‚úÖ **AUCUNE r√©f√©rence** √† isAgenceReseau dans le code
- ‚úÖ Aucune erreur TypeScript
- ‚úÖ Aucune erreur en console navigateur

---

## üìä IMPACT ESTIM√â

| Composant | Impact | Action |
|-----------|--------|--------|
| **Base de donn√©es** | Moyen | Suppression colonne + Nouvelle fonction |
| **Types TypeScript** | Faible | R√©g√©n√©ration automatique |
| **useMultiTenant** | √âlev√© | Modification logique core + nettoyage isAgenceReseau |
| **Queries Supabase** | Moyen | Adaptation des SELECT |
| **Performance** | Positif | Plus de donn√©es incoh√©rentes |
| **Maintenance** | Positif | Structure Business R√©elle align√©e |

---

## üèóÔ∏è STRUCTURE BUSINESS FINALE

**Types retourn√©s par get_organisation_type() :**
- "reseau" - Pour organisations dans reseau OU reseau_agence
- "agence_independante" - Pour organisations dans agence_independante
- NULL - Pour PRESENCA (g√©r√© par users_role_systeme = 'admin_presenca')

**Classifications dans useMultiTenant :**
- isReseau - Inclut t√™te de r√©seau ET agences de r√©seau
- isAgenceIndep - Agences ind√©pendantes uniquement
- isPresenca - Admins syst√®me PRESENCA

**‚ö†Ô∏è INTERDIT :** Toute r√©f√©rence √† isAgenceReseau est une erreur h√©rit√©e de l'ancienne conception.

---

*Plan d√©taill√© g√©n√©r√© pour pr√©sentation OpenAI - Expert IA No-Code Integration*
*Align√© Structure Business R√©elle - R√©vision finale 12.08.2025*
