# ÉTUDE D'IMPACT - Suppression `organisation_type_structure`

## 📋 ANALYSE GLOBALE

Le champ `organisation_type_structure` est **largement utilisé** à travers le système. Sa suppression nécessite une migration complète et coordonnée.

---

## 🏗️ 1. IMPACT SUPABASE

### 📊 Tables Impactées
- **`organisations`** : Champ principal avec contrainte CHECK
- **Toutes les autres tables** : Aucune référence directe (✅ Bon point)

### 🔧 Triggers & Fonctions
- **Aucun trigger spécifique** utilisant ce champ
- **Aucune fonction** utilisant directement ce champ
- ✅ **Impact minimal** côté triggers/fonctions

### 📝 Migrations Concernées
```sql
-- 6 migrations contiennent organisation_type_structure :
20250721151826-9b8a01f2-0735-49e2-910c-606def370e7b.sql
20250730123404-18912366-e681-457a-bb84-de32cf4629df.sql
20250730131558-3383b184-fc6e-4df2-a088-978a98d9fa87.sql
20250730131719-dde71859-2011-4d45-bad4-0729c43335ea.sql
20250730162027-025be394-cfdc-489a-9b88-58e8baecfc48.sql
20250730162254-24a33fdc-9f3e-4c94-af31-373f305e6986.sql
```

### 🎯 Actions Supabase Nécessaires
1. **Nouvelle migration** pour supprimer :
   - Contrainte CHECK `check_organisation_type_structure`
   - Colonne `organisation_type_structure`
2. **Créer fonction SQL** `get_organisation_type()` pour remplacement dynamique
3. **Mettre à jour les types Supabase** (automatique)

---

## 💻 2. IMPACT APPLICATION

### 🎯 Hooks Stratégiques Impactés

#### `useMultiTenant` ⚠️ **CRITIQUE**
- **Fichier** : `src/components/HOOKS-STRATEGIQUE/3.HOOK-useMultiTenant/useMultiTenant.ts`
- **Usage** : 
  ```typescript
  const organisationType = organisation?.organisation_type_structure ?? null;
  const isReseau = organisationType === "reseau";
  const isAgenceReseau = organisationType === "agence_reseau"; 
  const isAgenceIndep = organisationType === "agence_indep";
  ```
- **Impact** : Hook central pour la logique multi-tenant

#### `useCurrentUser` ⚠️ **MODÉRÉ**
- **Fichier** : `src/components/HOOKS-STRATEGIQUE/2.HOOK-useCurrentUser/types.ts`
- **Usage** : Interface TypeScript `organisation_type_structure: string | null`

### 🔌 Intégrations Supabase

#### `types.ts` ⚠️ **CRITIQUE**
- **Fichier** : `src/integrations/supabase/types.ts` (READ-ONLY)
- **Impact** : Types auto-générés - se mettront à jour automatiquement

#### `queries.ts` ⚠️ **CRITIQUE**
- **Fichier** : `src/integrations/supabase/queries.ts`
- **Lignes** : 129, 160, 288
- **Usage** : Requêtes SELECT incluant `organisation_type_structure`

#### `helpers.ts` ⚠️ **MODÉRÉ**
- **Fichier** : `src/integrations/supabase/helpers.ts`
- **Ligne** : 250
- **Usage** : Requête SELECT incluant `organisation_type_structure`

### 📁 Autres Fichiers Impactés

#### Documentation/Historique (Non critique)
- `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/6-DOCS-TABLES-UTILISEES/`
  - `1.HISTORIQUE.txt`
  - `2.TABLES-AUTH/02.TABLE CONNEXION - organisations.csv`
  - `30.07.2025.RAPPORT-AUDIT.txt`
- `src/components/HOOKS-STRATEGIQUE/9.Bibliotheque/2.1.BilanHook-useCurrentUser.md`

---

## 🎯 3. PLAN D'ACTION RECOMMANDÉ

### Phase 1 : Préparation Supabase
1. ✅ Créer fonction `get_organisation_type()` 
2. ✅ Tester la fonction avec des données existantes

### Phase 2 : Migration Application
1. 🔄 **Modifier `useMultiTenant`** : Remplacer logique par fonction SQL
2. 🔄 **Modifier `queries.ts`** : Utiliser fonction au lieu du champ
3. 🔄 **Modifier `helpers.ts`** : Utiliser fonction au lieu du champ
4. 🔄 **Modifier `types.ts` useCurrentUser** : Adapter interface

### Phase 3 : Suppression Supabase
1. 🗑️ Migration pour supprimer contrainte CHECK
2. 🗑️ Migration pour supprimer colonne
3. ✅ Vérification types auto-générés

### Phase 4 : Nettoyage
1. 📝 Mettre à jour documentation
2. 🧪 Tests de régression complets

---

## ⚡ RÉSUMÉ IMPACT

| Niveau | Impact | Fichiers Critiques | Actions |
|--------|--------|-------------------|---------|
| **Supabase** | 🟡 Modéré | 1 table, 6 migrations | Fonction SQL + Migration |
| **Application** | 🔴 Élevé | 4 hooks/helpers critiques | Refactoring complet |
| **Risque** | 🟡 Contrôlable | Multi-tenant logic | Planning rigoureux requis |

**Estimation** : 2-3 jours de développement + tests approfondis