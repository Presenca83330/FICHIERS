# Ã‰TUDE D'IMPACT - Suppression `organisation_type_structure`

## ğŸ“‹ ANALYSE GLOBALE

Le champ `organisation_type_structure` est **largement utilisÃ©** Ã  travers le systÃ¨me. Sa suppression nÃ©cessite une migration complÃ¨te et coordonnÃ©e.

---

## ğŸ—ï¸ 1. IMPACT SUPABASE

### ğŸ“Š Tables ImpactÃ©es
- **`organisations`** : Champ principal avec contrainte CHECK
- **Toutes les autres tables** : Aucune rÃ©fÃ©rence directe (âœ… Bon point)

### ğŸ”§ Triggers & Fonctions
- **Aucun trigger spÃ©cifique** utilisant ce champ
- **Aucune fonction** utilisant directement ce champ
- âœ… **Impact minimal** cÃ´tÃ© triggers/fonctions

### ğŸ“ Migrations ConcernÃ©es
```sql
-- 6 migrations contiennent organisation_type_structure :
20250721151826-9b8a01f2-0735-49e2-910c-606def370e7b.sql
20250730123404-18912366-e681-457a-bb84-de32cf4629df.sql
20250730131558-3383b184-fc6e-4df2-a088-978a98d9fa87.sql
20250730131719-dde71859-2011-4d45-bad4-0729c43335ea.sql
20250730162027-025be394-cfdc-489a-9b88-58e8baecfc48.sql
20250730162254-24a33fdc-9f3e-4c94-af31-373f305e6986.sql
```

### ğŸ¯ Actions Supabase NÃ©cessaires
1. **Nouvelle migration** pour supprimer :
   - Contrainte CHECK `check_organisation_type_structure`
   - Colonne `organisation_type_structure`
2. **CrÃ©er fonction SQL** `get_organisation_type()` pour remplacement dynamique
3. **Mettre Ã  jour les types Supabase** (automatique)

---

## ğŸ’» 2. IMPACT APPLICATION

### ğŸ¯ Hooks StratÃ©giques ImpactÃ©s

#### `useMultiTenant` âš ï¸ **CRITIQUE**
- **Fichier** : `src/components/HOOKS-STRATEGIQUE/3.HOOK-useMultiTenant/useMultiTenant.ts`
- **Usage** : 
  ```typescript
  const organisationType = organisation?.organisation_type_structure ?? null;
  const isReseau = organisationType === "reseau";
  const isAgenceReseau = organisationType === "agence_reseau"; 
  const isAgenceIndep = organisationType === "agence_indep";
  ```
- **Impact** : Hook central pour la logique multi-tenant

#### `useCurrentUser` âš ï¸ **MODÃ‰RÃ‰**
- **Fichier** : `src/components/HOOKS-STRATEGIQUE/2.HOOK-useCurrentUser/types.ts`
- **Usage** : Interface TypeScript `organisation_type_structure: string | null`

### ğŸ”Œ IntÃ©grations Supabase

#### `types.ts` âš ï¸ **CRITIQUE**
- **Fichier** : `src/integrations/supabase/types.ts` (READ-ONLY)
- **Impact** : Types auto-gÃ©nÃ©rÃ©s - se mettront Ã  jour automatiquement

#### `queries.ts` âš ï¸ **CRITIQUE**
- **Fichier** : `src/integrations/supabase/queries.ts`
- **Lignes** : 129, 160, 288
- **Usage** : RequÃªtes SELECT incluant `organisation_type_structure`

#### `helpers.ts` âš ï¸ **MODÃ‰RÃ‰**
- **Fichier** : `src/integrations/supabase/helpers.ts`
- **Ligne** : 250
- **Usage** : RequÃªte SELECT incluant `organisation_type_structure`

### ğŸ“ Autres Fichiers ImpactÃ©s

#### Documentation/Historique (Non critique)
- `src/components/ADMIN-PRESENCA/9-CreationComptesUtilisateurs/6-DOCS-TABLES-UTILISEES/`
  - `1.HISTORIQUE.txt`
  - `2.TABLES-AUTH/02.TABLE CONNEXION - organisations.csv`
  - `30.07.2025.RAPPORT-AUDIT.txt`
- `src/components/HOOKS-STRATEGIQUE/9.Bibliotheque/2.1.BilanHook-useCurrentUser.md`

---

## ğŸ¯ 3. PLAN D'ACTION RECOMMANDÃ‰

### Phase 1 : PrÃ©paration Supabase
1. âœ… CrÃ©er fonction `get_organisation_type()` 
2. âœ… Tester la fonction avec des donnÃ©es existantes

### Phase 2 : Migration Application
1. ğŸ”„ **Modifier `useMultiTenant`** : Remplacer logique par fonction SQL
2. ğŸ”„ **Modifier `queries.ts`** : Utiliser fonction au lieu du champ
3. ğŸ”„ **Modifier `helpers.ts`** : Utiliser fonction au lieu du champ
4. ğŸ”„ **Modifier `types.ts` useCurrentUser** : Adapter interface

### Phase 3 : Suppression Supabase
1. ğŸ—‘ï¸ Migration pour supprimer contrainte CHECK
2. ğŸ—‘ï¸ Migration pour supprimer colonne
3. âœ… VÃ©rification types auto-gÃ©nÃ©rÃ©s

### Phase 4 : Nettoyage
1. ğŸ“ Mettre Ã  jour documentation
2. ğŸ§ª Tests de rÃ©gression complets

---

## âš¡ RÃ‰SUMÃ‰ IMPACT

| Niveau | Impact | Fichiers Critiques | Actions |
|--------|--------|-------------------|---------|
| **Supabase** | ğŸŸ¡ ModÃ©rÃ© | 1 table, 6 migrations | Fonction SQL + Migration |
| **Application** | ğŸ”´ Ã‰levÃ© | 4 hooks/helpers critiques | Refactoring complet |
| **Risque** | ğŸŸ¡ ContrÃ´lable | Multi-tenant logic | Planning rigoureux requis |

**Estimation** : 2-3 jours de dÃ©veloppement + tests approfondis