# RELATIONS-BUSINESS-ENTRE-TABLES – LeadGenAI AdBuilder
**Version Finale – 13/08/2025**  
**Statut : Document de référence – Normatif & Permanent**

---

## 1. Modèle Cible (Normatif) – Comment ça doit être

### 1.1 Vue d’ensemble stratégique
Architecture multi-tenant hiérarchique à 3 niveaux :

- **RÉSEAU** : Groupes de franchises ou réseaux immobiliers  
- **AGENCE** : Agences individuelles (réseau ou indépendantes)  
- **UTILISATEURS** : Collaborateurs et responsables  

### 1.2 Tables organisationnelles
Table pivot : **organisations**  
Toutes les entités métier y sont rattachées via `organisation_id`  
RLS obligatoire sur cette table et toutes les tables liées  

**Relations clés :**
- `users.users_organisation_id` → `organisations.organisation_id`
- `utilisateurs.utilisateur_organisation_id` → `organisations.organisation_id`
- Toutes les tables métier → `organisations.organisation_id`

Le type d’organisation est désormais calculé dynamiquement via la fonction SQL :  
`get_organisation_type(organisation_id)` qui renvoie :  
- **reseau** (inclut réseaux + agences réseau)  
- **agence_independante**  
- **NULL** pour PRESENCA (géré par rôle système)  

### 1.3 Relation USERS ↔ UTILISATEURS (Pivot métier)
`users` (authentification) :  
- Lien direct avec `auth.users(id)`  
- Contient identifiants, rôle système, organisation rattachée  
- `users_auth_id` (UUID) UNIQUE → `auth.users(id)`  

`utilisateurs` (profil métier) :  
- Extension obligatoire de `users`  
- `utilisateur_auth_uid` (UUID) UNIQUE → `auth.users(id)` (via `users.users_auth_id`)  
- **ON DELETE CASCADE** obligatoire  
- Contient : prénom, nom, rôle métier, type de compte, statut, téléphone  
- Isolation RLS basée sur `utilisateur_organisation_id`  

**Relation stricte 1:1** : un `users` ↔ un `utilisateurs`

**Principe :**
- `users` gère uniquement l’authentification et la connexion  
- `utilisateurs` stocke le profil métier complet et les droits applicatifs  
- Suppression d’un `users` ⇒ suppression automatique du `utilisateurs` associé  

**Structure et Liens métier :**
- `reseau_agence_responsable.user_id` → `utilisateurs.id`
- `reseau_agence_collaborateur.user_id` → `utilisateurs.id`
- `agence_independante_responsable.user_id` → `utilisateurs.id`
- `agence_independante_collaborateur.user_id` → `utilisateurs.id`

### 1.4 Structures hiérarchiques

**Réseau :**
- `reseau (1)` → `(N) reseau_agence`
- `reseau_agence (1)` → `(N) reseau_agence_responsable`
- `reseau_agence (1)` → `(N) reseau_agence_collaborateur`

**Agence indépendante :**
- `agence_independante (1)` → `(N) agence_independante_responsable`
- `agence_independante (1)` → `(N) agence_independante_collaborateur`

### 1.5 Intégrations externes
Relations organisation → connexion API :
- `organisation (1)` → `(0..1) brevo_connexion`
- `organisation (1)` → `(0..1) zoho_connexion`
- `organisation (1)` → `(0..1) openai_connexion`
- `organisation (1)` → `(0..1) linkedin_connexion`
- `organisation (1)` → `(0..1) facebook_connexion`
- `organisation (1)` → `(0..1) instagram_connexion`

### 1.6 Sécurité
- **RLS** : `organisation_id = get_user_organisation_id(auth.uid())`
- **Admin PRESENCA** : `is_admin_presenca(auth.uid())`
- **Triggers audit** :  
  - `set_created_audit_fields` (BEFORE INSERT)  
  - `update_audit_fields` (BEFORE UPDATE)  
- **Secrets** : jamais de clé privée dans le code, uniquement dans Supabase Secrets  

---

## 2. Erreurs fréquentes & Pièges IA à éviter

- Confusion `users` / `utilisateurs`  
  → FK pivot = `utilisateur_auth_uid` → `auth.users(id)` via `users.users_auth_id`  
  → Ne jamais lier via `utilisateur_id` ou `users_id`  

- Hooks obsolètes  
  → Ne pas utiliser `useProfile` avec `users_id`  
  → Utiliser uniquement les hooks **Perfect Foundations**  

- RLS manquante sur organisations  
  → Sans RLS, l’utilisateur ne voit pas son organisation → accès cassé  

- Absence de triggers audit  
  → Toute table métier doit avoir triggers INSERT/UPDATE actifs  

- Accès admin global non contrôlé  
  → Vérification stricte avec `is_admin_presenca`  

---

## 3. Points de contrôle avant validation

| Contrôle | Attendu | Méthode |
|----------|---------|---------|
| Lien users ↔ utilisateurs | 1:1 via utilisateur_auth_uid | Vérifier contrainte UNIQUE & FK |
| RLS organisations | Isolation par organisation active | Vérifier policies Supabase |
| Triggers audit | Présents sur toutes les tables métier | `\d+ table_name` dans psql |
| Hooks actifs | “Perfect Foundations” uniquement | Audit du code React |
| Secrets | Stockés dans Supabase Secrets | `supabase secrets list` |

---

**Conclusion**  
Ce document est la **source unique de vérité** pour l’architecture relationnelle métier de **LeadGenAI AdBuilder**.  
Toute analyse IA Lovable doit s’y référer pour :  
- Détecter les écarts  
- Proposer des corrections  
- Garantir la cohérence multi-tenant et la sécurité  
