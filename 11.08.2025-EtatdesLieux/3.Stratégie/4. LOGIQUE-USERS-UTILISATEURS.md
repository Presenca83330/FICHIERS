# STRAT√âGIE USERS ‚Üî UTILISATEURS ‚Äì MOD√àLE PIVOT M√âTIER
**Document de r√©f√©rence architectural ‚Äì LeadGenAI AdBuilder**  
**Version** : 14/08/2025 ‚Äì Mise √† jour apr√®s corrections Lovable (Phases 1 √† 3)  
**Statut** : Source unique de v√©rit√© ‚Äì Architecture DB valid√©e et op√©rationnelle

---

## 1. PHILOSOPHIE ARCHITECTURALE

### 1.1 Vision SaaS Multi-Tenant
Dans notre architecture SaaS, la s√©paration entre **authentification** et **profil m√©tier** est fondamentale :

- **Authentification** = "Qui es-tu ?" (identit√©, s√©curit√©, session)
- **Donn√©es m√©tier** = "Que peux-tu faire ?" (profil, permissions, contexte business)

**B√©n√©fices :**
- S√©curit√© renforc√©e (isolation stricte par organisation)
- √âvolutivit√© ind√©pendante de l'authentification
- Maintenance simplifi√©e
- Conformit√© aux standards SaaS

### 1.2 Principe de responsabilit√© unique
Chaque table a une responsabilit√© claire et non chevauchante :
- **users** : authentification et rattachement organisationnel
- **utilisateurs** : profil m√©tier complet et exploitable

```mermaid
graph TB
    subgraph "COUCHE AUTHENTIFICATION"
        AUTH_USERS[(üîë auth.users<br/>Supabase Auth<br/>- Session management<br/>- Token refresh<br/>- Security)]
        PUBLIC_USERS[(üë§ public.users<br/>Pont Auth<br/>- Lien auth.users<br/>- Organisation ID<br/>- R√¥le syst√®me)]
    end
    
    subgraph "COUCHE M√âTIER"
        UTILISATEURS[(üë• utilisateurs<br/>Profil Business<br/>- Nom, pr√©nom<br/>- Type compte<br/>- Statut m√©tier)]
        BUSINESS_ROLES[(üéØ Tables R√¥les<br/>- responsable<br/>- collaborateur<br/>- direction)]
    end
    
    subgraph "COUCHE ORGANISATION"
        ORGANISATIONS[(üè¢ organisations<br/>Multi-tenant<br/>- Configuration<br/>- Type structure)]
    end
    
    AUTH_USERS -.->|users_auth_id| PUBLIC_USERS
    PUBLIC_USERS -->|users_organisation_id| ORGANISATIONS
    PUBLIC_USERS -.->|users_auth_id| UTILISATEURS
    UTILISATEURS -->|utilisateur_organisation_id| ORGANISATIONS
    UTILISATEURS -->|user_id| BUSINESS_ROLES
```

---

## 2. MOD√àLE DE DONN√âES D√âTAILL√â

### 2.1 Table `users` ‚Äì Pont d'Authentification

**R√¥le :** Liaison entre `auth.users` (Supabase) et notre syst√®me m√©tier.

**Structure simplifi√©e :**
```sql
CREATE TABLE public.users (
  users_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  users_auth_id uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  users_email text NOT NULL UNIQUE,
  users_nom text NOT NULL,
  users_prenom text NOT NULL,
  users_telephone text,
  users_organisation_id uuid NOT NULL REFERENCES organisations(organisation_id) ON DELETE RESTRICT,
  users_role text NOT NULL DEFAULT 'client',
  users_role_systeme text,
  users_interface_par_defaut text DEFAULT 'client_espace',
  users_created_at timestamptz NOT NULL DEFAULT now()
);
```
**Notes :**
- `users_auth_id` contient la m√™me valeur que `utilisateur_auth_uid` dans la table `utilisateurs`.
- Les champs `users_email` et `users_organisation_id` sont synchronis√©s automatiquement via trigger.

### 2.2 Table `utilisateurs` ‚Äì Profil M√©tier
**R√¥le :** Extension m√©tier obligatoire de `users`.

**Structure simplifi√©e :**
```sql
CREATE TABLE public.utilisateurs (
  utilisateur_id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  utilisateur_auth_uid uuid NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  utilisateur_email text NOT NULL UNIQUE,
  utilisateur_organisation_id uuid NOT NULL REFERENCES organisations(organisation_id) ON DELETE RESTRICT,
  utilisateur_type_compte text NOT NULL,
  utilisateur_statut text NOT NULL DEFAULT 'actif',
  utilisateur_role_systeme text,
  utilisateur_date_inscription timestamptz NOT NULL DEFAULT now()
);
```
**Notes :**
- `utilisateur_auth_uid` contient la m√™me valeur que `users_auth_id` dans `users`.
- `utilisateur_email` et `utilisateur_organisation_id` sont maintenus synchronis√©s via triggers.

---

## 3. RELATION PIVOT 1:1
- FK obligatoires sur `users.users_auth_id` et `utilisateurs.utilisateur_auth_uid` vers `auth.users(id)` (CASCADE).
- Unicit√© garantie sur chaque champ d'auth (`users_auth_id`, `utilisateur_auth_uid`).
- Synchronisation automatique des champs communs (email, organisation_id, role_systeme) par triggers.

---

## 4. PROCESSUS OP√âRATIONNELS
### 4.1 Cr√©ation d'un utilisateur
**Workflow manuel ou via admin PRESENCA :**
1. Cr√©ation de l'entr√©e dans `users`
2. Cr√©ation de l'entr√©e dans `utilisateurs`
3. Envoi d'une invitation email via Supabase Auth
4. Aucun trigger automatique ne cr√©e `users` (fonction `handle_new_user()` supprim√©e).

### 4.2 Connexion
- R√©cup√©ration du profil complet via RPC `get_current_user_organisation()` qui joint `users`, `utilisateurs`, et `organisations`.
- S√©curit√© assur√©e par RLS.

---

## 5. S√âCURIT√â & RLS
### Table `users`
- **Admin PRESENCA** : acc√®s complet (`is_admin_presenca`)
- **Utilisateur** : acc√®s et modification uniquement de son propre profil (`users_auth_id = auth.uid()`)

### Table `utilisateurs`
- **Admin PRESENCA** : acc√®s complet
- **Utilisateur** : acc√®s √† son profil (`utilisateur_auth_uid = auth.uid()`)
- **Organisation** : acc√®s aux profils de la m√™me organisation

---

## 6. √âTAT ACTUEL APR√àS CORRECTIONS LOVABLE
‚úÖ FK critiques ajout√©es (relation 1:1 s√©curis√©e)
‚úÖ Triggers de synchronisation actifs (`users` ‚Üî `utilisateurs`)
‚úÖ Fonction `handle_new_user()` supprim√©e
‚úÖ RLS INSERT op√©rationnelle
‚úÖ 6/8 fonctions s√©curis√©es avec `SET search_path = 'public'` (2 warnings restants non critiques)
‚úÖ Tests de validation RLS, performance et int√©grit√© r√©ussis

---

## 7. CONCLUSION
La distinction `users` ‚Üî `utilisateurs` est d√©sormais :
- **Clair** : s√©paration auth / m√©tier
- **S√ªr** : int√©grit√© et RLS garantis
- **√âvolutif** : pr√™t pour futures fonctionnalit√©s multi-tenant

**Prochaine r√©vision :** 20/08/2025