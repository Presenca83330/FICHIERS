# SECURITE-SUPABASE.md
**Version Finale** – 13/08/2025  
**Statut :** Document de référence – Normatif & Permanent  

---

## 1. Vision & Modèle Cible (Normatif)

Objectif : disposer d’une architecture **Supabase Enterprise** sécurisée par défaut, conforme aux standards **RGPD** et **ISO 27001**, garantissant :  
- Isolation multi-tenant stricte (**RLS** sur toutes les tables métier)  
- Traçabilité totale (audit et logs sur toutes les opérations)  
- Sécurité des fonctions (`search_path` défini, `SECURITY DEFINER` maîtrisé)  
- Protection des données sensibles (gestion des secrets Supabase)  
- Performance et robustesse (retry, cache intelligent, monitoring)  
- Facilité de maintenance (documentation synchronisée, scripts d’audit automatisés)  

### 1.1 Phases du modèle cible

| Phase | Objectif | Exigences clés |
|-------|----------|---------------|
| **Phase 1** | Validation & Authentification | RLS activée partout, Auth Supabase avec rôles granulaires (`admin_presenca`, `client`...) |
| **Phase 2** | Audit & Observabilité | Triggers d’audit automatiques sur toutes les tables, table `1_historique_supabase` centrale |
| **Phase 3** | Résilience | Retry automatique, circuit breaker sur fonctions critiques |
| **Phase 4** | Performance | Cache organisationnel, monitoring temps réel |
| **Phase 5** | Fonctions avancées | Helpers métier optimisés, temps réel sécurisé (tracking de présence) |

---

## 2. Sources d’erreurs courantes à surveiller (IA)

1. Fonctions critiques non sécurisées  
   - Absence de `search_path = 'public'`  
   - `SECURITY DEFINER` sans contrôle strict  
2. RLS incomplète  
   - Pas de politique sur `organisations`  
   - Accès admin global mal protégé  
3. Triggers d’audit manquants  
   - Certaines tables (`organisations`, `users`, `utilisateurs`) non couvertes  
4. Clés API exposées  
   - Présence dans le code au lieu de Supabase Secrets  
5. Absence de contrôles en production  
   - Pas de `log_audit_event` pour les modifications manuelles  
6. Utilisation de `user_metadata` pour la logique d’accès  
   - Interdit : la source de vérité des rôles et types est en base (`users`, `utilisateurs`)  
7. Redirections incorrectes  
   - Non-conformité avec la règle centralisée `useAuth.getRedirectPath()`  

---

## 3. Écarts actuels connus à corriger

| Catégorie | Écart détecté | Impact | Correctif attendu |
|-----------|--------------|--------|-------------------|
| **Sécurité** | `get_user_organisation_id` et `log_audit_event` non sécurisés | Vulnérabilité critique | Ajouter `search_path='public'`, audit, test RLS |
| **RLS** | Pas de politique utilisateur sur `organisations` | Les utilisateurs ne voient pas leur organisation | Ajouter policy `organisation_id = get_user_organisation_id(auth.uid())` |
| **Audit** | Triggers manquants sur 3 tables | Perte de traçabilité | Ajouter triggers insert/update |
| **Robustesse** | Circuit breaker et retry non implémentés | Risque de blocage en cas de panne | Implémenter patterns de résilience |
| **Performance** | Pas de cache intelligent ni monitoring temps réel | Latence possible | Mettre en place TTL + invalidation auto |
| **Fonctions avancées** | Pas de tracking de présence sécurisé | Incohérence temps réel | Implémenter via Supabase Realtime |
| **Normes d’accès** | Rôles et types non centralisés | Incohérences d’accès et de redirection | Utiliser uniquement les colonnes en base, pas `user_metadata` |

---

## 4. Normes obligatoires

### 4.1 Source de vérité des rôles et types
- Rôles système (`users.users_role_systeme`) : {`admin_presenca`, `superadmin`, `support`, null}  
- Rôles applicatifs (`users.users_role`) : {`client`, `admin`}  
- Types métier (`utilisateurs.utilisateur_type_compte`) : {`reseau`, `agence_independante`}  
- Sous-typages : (`reseau_agence_responsable`, `reseau_agence_collaborateur`, etc.) → gérés dans tables spécialisées  
- Interdit : toute logique d'autorisation, routage ou multi-tenant basée sur `user_metadata`  
- Obligatoire : lecture des rôles et types depuis les colonnes en base via `useCurrentUser` et `useMultiTenant`

### 4.2 Redirections Perfect Foundations
- Implémentées dans `useAuth.getRedirectPath()` :  
  - `admin_presenca` / `superadmin` → `/admin-presenca`  
  - `reseau` / `reseau_direction` → `/accueil-leadgenai`  
  - Clients (agences réseau/indépendantes) → `/accueil-leadgenai`  

---

## 5. Politiques RLS critiques

```sql
CREATE POLICY organisations_select_by_org
ON organisations FOR SELECT
USING (
  is_admin_presenca(auth.uid())
  OR organisation_id = get_user_organisation_id(auth.uid())
);
```

---

## 6. Triggers d’audit obligatoires

```sql
CREATE TRIGGER organisations_set_created_audit
BEFORE INSERT ON organisations
FOR EACH ROW EXECUTE FUNCTION set_created_audit_fields();

CREATE TRIGGER organisations_update_audit
BEFORE UPDATE ON organisations
FOR EACH ROW EXECUTE FUNCTION update_audit_fields();

-- Idem pour users et utilisateurs
```

---

## 7. Hooks Front – Contrat d’usage

- useAuth : état/session + `getRedirectPath()` (basé sur base de données, pas `user_metadata`)  
- useCurrentUser : profil `users` + organisation filtrée RLS  
- useMultiTenant : expose `effectiveOrganisationId` et gère l’impersonation  
- useSupabaseOperations : seul point d’accès CRUD aux tables  
- Interdit : toute requête Supabase directe dans composants ou contexts hors hooks  

---

## 8. Sécurisation des fonctions critiques

- Obligatoire : `SET search_path='public'` sur toutes les fonctions `SECURITY DEFINER`  
- À auditer :  
  - `get_user_organisation_id(uuid)`  
  - `log_audit_event(...)`  

---

## 9. Interdits absolus

- Bypasser RLS ou requêtes sans `organisation_id`  
- Laisser des clés API privées dans le code  
- Créer des `SECURITY DEFINER` sans `search_path`  
- Modifier en prod sans `log_audit_event`  
- Déployer sans triggers d’audit  

---

## 10. Points de contrôle avant validation

| Contrôle | Attendu | Méthode |
|----------|---------|---------|
| **RLS** | Active sur toutes les tables métier | Vérifier policies Supabase |
| **Fonctions critiques** | `search_path='public'` et audit | `\df+ function_name` |
| **Audit** | Triggers insert/update présents | `\d+ table_name` |
| **Secrets** | Stockés dans Supabase Secrets | `supabase secrets list` |
| **Perf & Résilience** | Cache + retry + circuit breaker opérationnels | Tests de charge |

---

## Conclusion

Ce document est la source unique de vérité pour la sécurité Supabase de LeadGenAI AdBuilder.  
Toute analyse IA Lovable doit :  
- Se baser sur ce modèle cible  
- Identifier les écarts  
- Proposer des correctifs strictement conformes à ce document
