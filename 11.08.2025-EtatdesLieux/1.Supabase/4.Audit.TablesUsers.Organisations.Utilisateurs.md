
Instruction : Remplir cette checklist après avoir analysé directement la base Supabase (organisations, users, utilisateurs).
L'objectif est de produire un état des lieux complet et de détecter tous les écarts, même mineurs.

# 📋 Checklist Audit – Tables `organisations`, `users`, `utilisateurs`

## **1. Structure des tables**
| Table         | Colonnes présentes | Types corrects | Contraintes (PK/FK) | Valeurs par défaut OK | Conforme (✅/❌) | Commentaire |
|---------------|-------------------|----------------|---------------------|-----------------------|-----------------|-------------|
| organisations | 14 colonnes : organisation_id, organisation_type_structure, organisation_nom, organisation_siret, organisation_identite_commerciale, organisation_adresse, organisation_code_postal, organisation_ville, organisation_telephone, organisation_email, organisation_plan_stripe, organisation_statut_compte, organisation_statut_paiement, organisation_date_creation | ✅ | PK: organisation_id (uuid) | ✅ | ❌ | **MANQUE**: created_at, updated_at, created_by, updated_by |
| users         | 11 colonnes : users_id, users_auth_id, users_email, users_nom, users_prenom, users_telephone, users_organisation_id, users_role, users_role_systeme, users_interface_par_defaut, users_created_at | ✅ | PK: users_id (uuid) | ✅ | ❌ | **MANQUE**: updated_at, created_by, updated_by |
| utilisateurs  | 8 colonnes : utilisateur_id, utilisateur_organisation_id, utilisateur_email, utilisateur_auth_uid, utilisateur_type_compte, utilisateur_date_inscription, utilisateur_statut, utilisateur_role_systeme | ✅ | PK: utilisateur_id (uuid) | ✅ | ❌ | **MANQUE**: created_at, updated_at, created_by, updated_by |

---

## **2. Audit complet des triggers**

### **Étape 1 : Triggers sur les tables critiques**

| Table | Trigger Name | Timing | Event | Fonction exécutée | Status |
|-------|-------------|--------|-------|------------------|--------|
| organisations | organisations_insert_audit | BEFORE | INSERT | set_created_audit_fields_organisations() | ✅ ACTIF |
| organisations | organisations_update_audit | BEFORE | UPDATE | update_audit_fields_organisations() | ✅ ACTIF |
| users | users_insert_audit | BEFORE | INSERT | set_created_audit_fields_users() | ✅ ACTIF |
| users | users_update_audit | BEFORE | UPDATE | update_audit_fields_users() | ✅ ACTIF |
| utilisateurs | utilisateurs_insert_audit | BEFORE | INSERT | set_created_audit_fields_utilisateurs() | ✅ ACTIF |
| utilisateurs | utilisateurs_update_audit | BEFORE | UPDATE | update_audit_fields_utilisateurs() | ✅ ACTIF |

### **Étape 2 : Analyse des fonctions associées**

| Fonction | Code de la fonction | Colonnes utilisées | Conforme (✅/❌) | Commentaire |
|----------|--------------------|--------------------|-----------------|-------------|
| `set_created_audit_fields_organisations` | ```NEW.created_at := now(); NEW.created_by := auth.uid();``` | created_at, created_by | ❌ | Colonnes inexistantes dans la table |
| `update_audit_fields_organisations` | ```NEW.updated_at := now(); NEW.updated_by := auth.uid();``` | updated_at, updated_by | ❌ | Colonnes inexistantes dans la table |
| `set_created_audit_fields_users` | ```NEW.created_at := now(); NEW.created_by := auth.uid();``` | created_at, created_by | ❌ | created_at manque, created_by manque |
| `update_audit_fields_users` | ```NEW.updated_at := now(); NEW.updated_by := auth.uid();``` | updated_at, updated_by | ❌ | Colonnes inexistantes dans la table |
| `set_created_audit_fields_utilisateurs` | ```NEW.created_at := now(); NEW.created_by := auth.uid();``` | created_at, created_by | ❌ | Colonnes inexistantes dans la table |
| `update_audit_fields_utilisateurs` | ```NEW.updated_at := now(); NEW.updated_by := auth.uid();``` | updated_at, updated_by | ❌ | Colonnes inexistantes dans la table |

---

## **3. Tableau récapitulatif : Trigger → Fonction → Conformité**

| Table | Trigger | Fonction associée | Conforme (✅/❌) | Commentaire |
|-------|---------|------------------|-----------------|-------------|
| organisations | organisations_insert_audit | set_created_audit_fields_organisations | ❌ | Trigger actif mais échoue : colonnes created_at, created_by manquantes |
| organisations | organisations_update_audit | update_audit_fields_organisations | ❌ | Trigger actif mais échoue : colonnes updated_at, updated_by manquantes |
| users | users_insert_audit | set_created_audit_fields_users | ❌ | Trigger actif mais échoue : colonnes created_at, created_by manquantes |
| users | users_update_audit | update_audit_fields_users | ❌ | Trigger actif mais échoue : colonnes updated_at, updated_by manquantes |
| utilisateurs | utilisateurs_insert_audit | set_created_audit_fields_utilisateurs | ❌ | Trigger actif mais échoue : colonnes created_at, created_by manquantes |
| utilisateurs | utilisateurs_update_audit | update_audit_fields_utilisateurs | ❌ | Trigger actif mais échoue : colonnes updated_at, updated_by manquantes |

---

## **4. Intégration avec `1_historique_supabase`**
| Table         | INSERT journalisé ? | UPDATE journalisé ? | Conforme (✅/❌) | Commentaire |
|---------------|---------------------|---------------------|-----------------|-------------|
| organisations | ❌ NON | ❌ NON | ❌ | Triggers actifs mais échouent (colonnes manquantes) |
| users         | ❌ NON | ❌ NON | ❌ | Triggers actifs mais échouent (colonnes manquantes) |
| utilisateurs  | ❌ NON | ❌ NON | ❌ | Triggers actifs mais échouent (colonnes manquantes) |

---

## **5. Écarts et recommandations**

### 🔴 **PROBLÈMES CRITIQUES DÉTECTÉS**

**Colonnes manquantes ou à renommer :**
- `organisations` : Manque `created_at`, `updated_at`, `created_by`, `updated_by`
- `users` : Manque `updated_at`, `created_by`, `updated_by` (a `users_created_at` mais les fonctions cherchent `created_at`)
- `utilisateurs` : Manque `created_at`, `updated_at`, `created_by`, `updated_by`

**Fonctions à mettre à jour :**
- ✅ Toutes les fonctions d'audit existent et sont correctement codées
- ❌ Elles référencent des colonnes inexistantes dans les tables

**Triggers à recréer ou corriger :**
- ✅ **Tous les triggers d'audit sont DÉJÀ configurés** sur les 3 tables
- ❌ **MAIS ils échouent silencieusement** car les colonnes cibles n'existent pas

### 📋 **Scripts SQL proposés :**

```sql
-- ===== SOLUTION : AJOUT DES COLONNES D'AUDIT MANQUANTES =====
-- Les triggers existent déjà, il faut juste ajouter les colonnes cibles

-- Table organisations
ALTER TABLE public.organisations 
ADD COLUMN created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN created_by UUID,
ADD COLUMN updated_by UUID;

-- Table users (updated_at manque, les autres aussi)
ALTER TABLE public.users 
ADD COLUMN updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN created_by UUID,
ADD COLUMN updated_by UUID;

-- Table utilisateurs  
ALTER TABLE public.utilisateurs 
ADD COLUMN created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN updated_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
ADD COLUMN created_by UUID,
ADD COLUMN updated_by UUID;
```

### ⚠️ **IMPACT CORRIGÉ**
- ✅ Les triggers existent déjà et sont correctement configurés
- ❌ **Problème réel** : Triggers actifs mais échouent silencieusement (colonnes manquantes)
- 🎯 **Solution** : Ajouter uniquement les colonnes d'audit, les triggers fonctionneront immédiatement
- 📊 **Résultat attendu** : Audit automatique opérationnel sur les 3 tables critiques

---

### 📌 Instruction
Remplir **tous** les champs de cette checklist.  
Lister **clairement** chaque écart trouvé.  
Proposer les corrections sous forme de **scripts SQL prêts à exécuter**.  
Ne pas modifier le RLS ou les droits d'accès.  
Ne pas supprimer ou renommer de colonnes sans validation explicite.
