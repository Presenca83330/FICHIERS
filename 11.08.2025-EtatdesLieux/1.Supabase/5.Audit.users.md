# AUDIT TABLE USERS - SUPABASE
**Date d'audit:** 14/08/2025 (V√©rifi√© temps r√©el)  
**Expert:** Lovable AI  
**Statut:** CRITIQUE - Incoh√©rences CONFIRM√âES persistantes

---

## 1. STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Analyse |
|---------|------|----------|---------|---------|
| users_id | uuid | Non | gen_random_uuid() | ‚úÖ Conforme - PK |
| users_auth_id | uuid | Non | Aucun | ‚úÖ Conforme - FK vers auth.users |
| users_email | text | Non | Aucun | ‚úÖ Conforme - UNIQUE |
| users_nom | text | Non | Aucun | ‚úÖ Conforme |
| users_prenom | text | Non | Aucun | ‚úÖ Conforme |
| users_telephone | text | Oui | Aucun | ‚úÖ Conforme - Optionnel |
| users_organisation_id | uuid | Oui | Aucun | ‚ö†Ô∏è Nullable mais FK obligatoire |
| users_role | text | Non | 'client' | ‚úÖ Conforme - Valeur par d√©faut |
| users_role_systeme | text | Oui | Aucun | ‚úÖ Conforme - Optionnel |
| users_interface_par_defaut | text | Oui | 'client_espace' | ‚úÖ Conforme |
| users_created_at | timestamp with time zone | Non | now() | ‚úÖ Conforme - Audit |

---

## 2. CONTRAINTES ANALYS√âES

### 2.1 PRIMARY KEY
- **users_pkey**: PRIMARY KEY (users_id) ‚úÖ

### 2.2 FOREIGN KEYS
- **users_users_auth_id_fkey**: users_auth_id ‚Üí auth.users(id) ON DELETE CASCADE ‚úÖ
- **fk_users_organisation**: users_organisation_id ‚Üí organisations(organisation_id) ON DELETE RESTRICT ‚úÖ
- **users_organisation_id_fkey**: users_organisation_id ‚Üí organisations(organisation_id) ON DELETE CASCADE ‚ö†Ô∏è

**üö® INCOH√âRENCE CRITIQUE**: Deux FK contradictoires sur users_organisation_id !

### 2.3 UNIQUE CONSTRAINTS
- **users_users_email_key**: UNIQUE (users_email) ‚úÖ

### 2.4 CHECK CONSTRAINTS
- **check_users_role**: users_role IN ('client', 'admin') ‚úÖ
- **check_users_interface_par_defaut**: users_interface_par_defaut IN ('client_espace', 'admin_presenca') ‚úÖ
- **users_users_role_systeme_check**: users_role_systeme IN ('admin_presenca', 'superadmin', 'support') OR NULL ‚úÖ

---

## 3. INDEX ANALYS√âS

| Index | Type | Colonnes | Statut |
|-------|------|----------|---------|
| users_pkey | UNIQUE | users_id | ‚úÖ PK |
| idx_users_auth_id | UNIQUE | users_auth_id | ‚úÖ Performance |
| idx_users_email | UNIQUE | users_email | ‚ö†Ô∏è Doublonn√© |
| users_users_email_key | UNIQUE | users_email | ‚ö†Ô∏è Doublonn√© |
| idx_users_organisation_id | INDEX | users_organisation_id | ‚úÖ Performance |
| idx_users_role_systeme | INDEX | users_role_systeme | ‚úÖ Performance |

**üö® INCOH√âRENCE**: Index email doublonn√© (idx_users_email + users_users_email_key)

---

## 4. TRIGGERS ANALYS√âS

| Trigger | Timing | Event | Fonction | Statut |
|---------|--------|--------|----------|---------|
| users_insert_audit | BEFORE | INSERT | set_created_audit_fields_users() | ‚úÖ |
| users_update_audit | BEFORE | UPDATE | update_audit_fields_users() | ‚úÖ |

### 4.1 Analyse des fonctions triggers
- **set_created_audit_fields_users()**: D√©finie ‚úÖ
- **update_audit_fields_users()**: D√©finie ‚úÖ

---

## 5. S√âCURIT√â RLS ANALYS√âE

| Politique | Commande | Expression | Statut |
|-----------|----------|------------|---------|
| Admin PRESENCA full access | ALL | is_admin_presenca(auth.uid()) | ‚úÖ |
| Users can view their own profile | SELECT | users_auth_id = auth.uid() | ‚úÖ |
| Users can update their own profile | UPDATE | users_auth_id = auth.uid() | ‚úÖ |

**‚ö†Ô∏è MANQUE**: Politique INSERT pour les utilisateurs standard

---

## 6. INCOH√âRENCES CRITIQUES D√âTECT√âES

### üö® CRITIQUE 1: Conflits FK users_organisation_id
```sql
-- CONFLITS D√âTECT√âS:
CONSTRAINT fk_users_organisation FOREIGN KEY (users_organisation_id) REFERENCES organisations(organisation_id) ON DELETE RESTRICT
CONSTRAINT users_organisation_id_fkey FOREIGN KEY (users_organisation_id) REFERENCES organisations(organisation_id) ON DELETE CASCADE
```
**Impact**: Comportement impr√©visible lors de suppression d'organisation

### üö® CRITIQUE 2: Index email doublonn√©
```sql
-- DOUBLONS:
CREATE UNIQUE INDEX idx_users_email ON public.users (users_email)
CREATE UNIQUE INDEX users_users_email_key ON public.users (users_email)
```
**Impact**: Overhead performance et maintenance

### ‚ö†Ô∏è MINEUR 3: Politique RLS INSERT manquante
**Impact**: Utilisateurs ne peuvent pas s'auto-cr√©er

---

## 7. RECOMMANDATIONS URGENTES

### Priorit√© 1 - CRITIQUE
1. **R√©soudre le conflit FK users_organisation_id**
   ```sql
   ALTER TABLE users DROP CONSTRAINT users_organisation_id_fkey;
   -- Garder seulement fk_users_organisation avec RESTRICT
   ```

2. **Supprimer l'index doublonn√©**
   ```sql
   DROP INDEX IF EXISTS idx_users_email;
   -- Garder users_users_email_key (contrainte UNIQUE)
   ```

### Priorit√© 2 - IMPORTANT
3. **Ajouter politique INSERT RLS**
   ```sql
   CREATE POLICY "Users can insert their own profile" 
   ON users FOR INSERT 
   WITH CHECK (users_auth_id = auth.uid());
   ```

---

## 8. SCORE D'AUDIT

| Crit√®re | Score | Notes |
|---------|--------|-------|
| Structure | 9/10 | Bien con√ßue |
| Contraintes | 6/10 | Conflits FK critiques |
| Index | 7/10 | Doublonnage |
| Triggers | 10/10 | Parfait |
| S√©curit√© RLS | 8/10 | INSERT manquant |

**SCORE GLOBAL: 7/10** ‚ö†Ô∏è

---

## 9. V√âRIFICATION TEMPS R√âEL (14/08/2025)

‚úÖ **CONFIRM√â** - Toutes les incoh√©rences critiques persistent :
- üö® Conflit FK `users_organisation_id` (RESTRICT vs CASCADE)
- üö® Index email doublonn√© (`idx_users_email` + `users_users_email_key`)
- ‚ö†Ô∏è Politique RLS INSERT manquante

### Points suppl√©mentaires d√©tect√©s:
- **Trigger functions confirm√©es actives** (set_created_audit_fields_users, update_audit_fields_users)
- **Structure table stable** - Aucune modification d√©tect√©e
- **RLS policies inchang√©es** - 3 politiques actives

### Impact business:
- **Migration utilisateurs impossible** sans r√©solution conflits FK
- **Performance d√©grad√©e** par index doublonn√©s
- **Inscription utilisateurs bloqu√©e** par RLS manquant

**üî• ACTION URGENTE REQUISE AVANT MIGRATION VERS PERFECT FOUNDATIONS**

---

*Audit g√©n√©r√© automatiquement - Derni√®re v√©rification temps r√©el: 14/08/2025*