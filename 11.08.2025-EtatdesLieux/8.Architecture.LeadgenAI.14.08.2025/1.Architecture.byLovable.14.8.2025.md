# ARCHITECTURE LEADGENAI ADBUILDER
**Diagramme d'architecture généré le 14/08/2025**

---

## 🎯 VUE D'ENSEMBLE SYSTÈME

```mermaid
graph TB
    subgraph "UTILISATEURS"
        USER[👤 Utilisateur Final]
    end
    
    subgraph "FRONTEND LOVABLE"
        WEBAPP[🌐 Application Web React]
        WEBAPP --> AUTH[🔐 Authentification]
        WEBAPP --> CLIENT_UI[🏢 Interface Client]
        WEBAPP --> ADMIN_UI[⚙️ Interface Admin]
        WEBAPP --> RESEAU_UI[🏘️ Interface Réseau]
    end
    
    subgraph "SUPABASE BACKEND"
        AUTH_DB[(🔑 auth.users)]
        MAIN_DB[(📊 Base Principale)]
        RLS[🛡️ Row Level Security]
        FUNCTIONS[⚡ Edge Functions]
    end
    
    subgraph "AGENTS IA"
        IA_ANNONCE[📝 Agent Annonce]
        IA_MARKETING[📧 Agent Marketing]
        IA_LANDING[🌐 Agent Landing Page]
        IA_SOCIAL[📱 Agent Réseaux Sociaux]
        IA_SOURCING[🔍 Agent Sourcing]
        IA_CAMPAGNE[🎯 Agent Campagnes]
    end
    
    subgraph "APIS EXTERNES"
        OPENAI[🤖 OpenAI]
        BREVO[📧 Brevo]
        LINKEDIN[💼 LinkedIn]
        FACEBOOK[📘 Facebook]
        INSTAGRAM[📸 Instagram]
        STRIPE[💳 Stripe]
    end
    
    USER --> WEBAPP
    WEBAPP --> MAIN_DB
    WEBAPP --> AUTH_DB
    WEBAPP --> FUNCTIONS
    FUNCTIONS --> IA_ANNONCE
    FUNCTIONS --> IA_MARKETING
    FUNCTIONS --> IA_LANDING
    FUNCTIONS --> IA_SOCIAL
    FUNCTIONS --> IA_SOURCING
    FUNCTIONS --> IA_CAMPAGNE
    
    IA_ANNONCE --> OPENAI
    IA_MARKETING --> BREVO
    IA_SOCIAL --> LINKEDIN
    IA_SOCIAL --> FACEBOOK
    IA_SOCIAL --> INSTAGRAM
    WEBAPP --> STRIPE
```

---

## 🏗️ ARCHITECTURE MULTI-TENANT

```mermaid
graph TB
    subgraph "NIVEAU 1 - PRESENCA"
        PRESENCA[🏢 PRESENCA]
        ADMIN_PRESENCA[👨‍💼 Admin PRESENCA]
    end
    
    subgraph "NIVEAU 2 - ORGANISATIONS"
        subgraph "TYPE RÉSEAU"
            RESEAU[🏘️ RÉSEAU]
            RESEAU_DIR[👨‍💼 Direction Réseau]
            RESEAU_AGENCE[🏢 Agence Réseau]
        end
        
        subgraph "TYPE AGENCE INDÉPENDANTE"
            AGENCE_INDEP[🏢 Agence Indépendante]
        end
    end
    
    subgraph "NIVEAU 3 - UTILISATEURS"
        subgraph "RÉSEAU USERS"
            RESP_RESEAU[👨‍💼 Responsable Agence Réseau]
            COLLAB_RESEAU[👤 Collaborateur Réseau]
        end
        
        subgraph "AGENCE USERS"
            RESP_AGENCE[👨‍💼 Responsable Agence Indép]
            COLLAB_AGENCE[👤 Collaborateur Agence]
        end
    end
    
    PRESENCA --> RESEAU
    PRESENCA --> AGENCE_INDEP
    RESEAU --> RESEAU_DIR
    RESEAU --> RESEAU_AGENCE
    RESEAU_AGENCE --> RESP_RESEAU
    RESEAU_AGENCE --> COLLAB_RESEAU
    AGENCE_INDEP --> RESP_AGENCE
    AGENCE_INDEP --> COLLAB_AGENCE
```

---

## 📊 ARCHITECTURE BASE DE DONNÉES

```mermaid
erDiagram
    auth_users ||--|| users : "1:1"
    users ||--|| utilisateurs : "1:1"
    users }|--|| organisations : "N:1"
    
    organisations ||--o{ reseau : "1:N"
    organisations ||--o{ agence_independante : "1:N"
    
    reseau ||--o{ reseau_direction : "1:N"
    reseau ||--o{ reseau_agence : "1:N"
    
    reseau_agence ||--o{ reseau_agence_responsable : "1:N"
    reseau_agence ||--o{ reseau_agence_collaborateur : "1:N"
    
    agence_independante ||--o{ agence_independante_responsable : "1:N"
    agence_independante ||--o{ agence_independante_collaborateur : "1:N"
    
    utilisateurs ||--o{ reseau_agence_responsable : "1:N"
    utilisateurs ||--o{ reseau_agence_collaborateur : "1:N"
    utilisateurs ||--o{ agence_independante_responsable : "1:N"
    utilisateurs ||--o{ agence_independante_collaborateur : "1:N"
    
    organisations ||--o{ brevo_connexion : "1:1"
    organisations ||--o{ openai_connexion : "1:1"
    organisations ||--o{ linkedin_connexion : "1:1"
    organisations ||--o{ facebook_connexion : "1:1"
    organisations ||--o{ instagram_connexion : "1:1"
    organisations ||--o{ abonnement_stripe : "1:1"
    
    organisations ||--o{ historique_supabase : "1:N"
```

---

## 🔐 FLUX D'AUTHENTIFICATION

```mermaid
sequenceDiagram
    participant U as Utilisateur
    participant A as App Frontend
    participant S as Supabase Auth
    participant DB as Database
    participant RLS as Row Level Security
    
    U->>A: Connexion (email/password)
    A->>S: auth.signInWithPassword()
    S->>A: Retour auth.users.id
    A->>DB: Requête users via users_auth_id
    DB->>RLS: Vérification organisation_id
    RLS->>DB: Autorisation données org
    DB->>A: Profil utilisateur + permissions
    A->>U: Interface selon rôle/type
```

---

## 🎯 FLUX AGENTS IA

```mermaid
graph LR
    subgraph "DÉCLENCHEMENT"
        USER_ACTION[👤 Action Utilisateur]
        UI_BUTTON[🖱️ Clic Agent IA]
    end
    
    subgraph "TRAITEMENT"
        EDGE_FUNC[⚡ Edge Function]
        IA_LOGIC[🤖 Logique IA]
        API_CALL[📡 Appel API Externe]
    end
    
    subgraph "STOCKAGE"
        RESULT_DB[(💾 Résultat DB)]
        AUDIT_LOG[(📋 Log Audit)]
    end
    
    subgraph "RETOUR"
        UI_UPDATE[🔄 Mise à jour UI]
        NOTIFICATION[🔔 Notification]
    end
    
    USER_ACTION --> UI_BUTTON
    UI_BUTTON --> EDGE_FUNC
    EDGE_FUNC --> IA_LOGIC
    IA_LOGIC --> API_CALL
    API_CALL --> RESULT_DB
    API_CALL --> AUDIT_LOG
    RESULT_DB --> UI_UPDATE
    UI_UPDATE --> NOTIFICATION
```

---

## 🛡️ SÉCURITÉ RLS

```mermaid
graph TB
    subgraph "POLITIQUES RLS"
        ORG_POLICY[🏢 organisation_id = get_user_organisation_id()]
        ADMIN_POLICY[👨‍💼 is_admin_presenca()]
        SELF_POLICY[👤 user_id = auth.uid()]
    end
    
    subgraph "TABLES PROTÉGÉES"
        USERS_TABLE[(users)]
        UTILISATEURS_TABLE[(utilisateurs)]
        ORG_TABLE[(organisations)]
        CLIENT_TABLES[(tables clients)]
        CONNEXION_TABLES[(tables connexions)]
    end
    
    ORG_POLICY --> CLIENT_TABLES
    ORG_POLICY --> CONNEXION_TABLES
    ADMIN_POLICY --> ORG_TABLE
    ADMIN_POLICY --> USERS_TABLE
    SELF_POLICY --> UTILISATEURS_TABLE
```

---

## 📱 INTERFACES UTILISATEUR

```mermaid
graph TB
    subgraph "INTERFACE CLIENT-ESPACE"
        CLIENT_DASHBOARD[📊 Dashboard Client]
        CLIENT_AGENTS[🤖 Agents IA]
        CLIENT_STATS[📈 Statistiques]
        CLIENT_BILLING[💳 Facturation]
    end
    
    subgraph "INTERFACE RÉSEAU-ESPACE"
        RESEAU_DASHBOARD[📊 Dashboard Réseau]
        RESEAU_AGENCES[🏢 Gestion Agences]
        RESEAU_STATS[📈 Stats Réseau]
        RESEAU_BILLING[💰 Finances Réseau]
    end
    
    subgraph "INTERFACE ADMIN-PRESENCA"
        ADMIN_CLIENTS[👥 Gestion Clients]
        ADMIN_ORGS[🏢 Gestion Organisations]
        ADMIN_LOGS[📋 Logs Audit]
        ADMIN_SECURITY[🔒 Sécurité]
    end
    
    subgraph "AGENTS IA COMMUNS"
        AGENT_ANNONCE[📝 Génération Annonces]
        AGENT_MARKETING[📧 Campagnes Email]
        AGENT_LANDING[🌐 Landing Pages]
        AGENT_SOCIAL[📱 Réseaux Sociaux]
        AGENT_SOURCING[🔍 Sourcing Leads]
    end
    
    CLIENT_AGENTS --> AGENT_ANNONCE
    CLIENT_AGENTS --> AGENT_MARKETING
    CLIENT_AGENTS --> AGENT_LANDING
    CLIENT_AGENTS --> AGENT_SOCIAL
    CLIENT_AGENTS --> AGENT_SOURCING
```

---

## 💡 RECOMMANDATIONS

### ✅ Points Forts Actuels
- Architecture multi-tenant bien structurée
- Séparation claire des rôles et permissions
- Sécurité RLS implémentée
- Agents IA spécialisés

### ⚠️ Points d'Attention
- Relations FK à vérifier entre tables
- Triggers audit à compléter
- Tests de sécurité RLS à effectuer
- Documentation technique à synchroniser

### 🎯 Prochaines Étapes Suggérées
1. **Audit Supabase** : Vérifier intégrité des tables et relations
2. **Tests RLS** : Valider isolation entre organisations  
3. **Documentation** : Finaliser documentation technique
4. **Tests Utilisateur** : Valider parcours complets par rôle

---

**Demandez à OpenAI de créer un diagramme similaire et nous comparerons nos visions !** 🚀
