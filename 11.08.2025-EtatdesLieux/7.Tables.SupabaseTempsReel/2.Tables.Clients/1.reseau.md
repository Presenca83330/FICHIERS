# TABLE: reseau

**Date de g√©n√©ration:** 17.08.2025  
**Statut:** ‚úÖ ACTIVE  
**Type:** Table m√©tier - Clients r√©seaux

---

## üìã STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Description |
|---------|------|----------|--------|-------------|
| reseau_id | uuid | NO | gen_random_uuid() | üîë Identifiant unique |
| organisation_id | uuid | NO | - | üîó Organisation de rattachement |
| reseau_created_at | timestamp with time zone | NO | now() | Date de cr√©ation |
| reseau_created_by | uuid | YES | - | Cr√©√© par (utilisateur) |
| reseau_updated_at | timestamp with time zone | YES | now() | Date de modification |
| reseau_updated_by | uuid | YES | - | Modifi√© par (utilisateur) |
| reseau_date_inscription | timestamp with time zone | NO | now() | Date d'inscription |
| reseau_date_debut_abonnement | timestamp with time zone | YES | - | D√©but abonnement |
| reseau_date_resiliation_abonnement | timestamp with time zone | YES | - | Fin abonnement |
| reseau_abonnement_id | uuid | YES | - | üîó Abonnement Stripe |
| reseau_brevo_connexion_id | uuid | YES | - | üîó Connexion Brevo |
| reseau_openai_connexion_id | uuid | YES | - | üîó Connexion OpenAI |
| reseau_zoho_connexion_id | uuid | YES | - | üîó Connexion Zoho |
| client_id | uuid | NO | gen_random_uuid() | ID client g√©n√©rique |
| reseau_espace_client | boolean | NO | true | Acc√®s espace client |
| interdit_acces_admin_presenca | boolean | NO | false | Restriction admin PRESENCA |
| autorisation_acces_reseau_presenca | boolean | NO | true | Acc√®s plateforme PRESENCA |
| reseau_audit_log | jsonb | YES | - | Journal d'audit |
| reseau_ia_extensions | jsonb | YES | - | Extensions IA |
| reseau_nom | text | NO | - | Nom du r√©seau |
| reseau_identite_commerciale | text | YES | - | Nom commercial |
| reseau_adresse | text | NO | - | Adresse compl√®te |
| reseau_code_postal | text | NO | - | Code postal |
| reseau_ville | text | NO | - | Ville |
| reseau_telephone | text | NO | - | T√©l√©phone |
| reseau_email | text | NO | - | Email principal |
| reseau_siret | text | NO | - | Num√©ro SIRET |
| reseau_statut_abonnement | text | YES | - | Statut abonnement |
| reseau_plan | text | YES | - | Plan souscrit |
| reseau_statut_paiement | text | YES | - | Statut paiement |
| reseau_logo | text | YES | - | URL du logo |
| reseau_ressources | ARRAY | YES | - | Ressources disponibles |
| reseau_statut | text | NO | 'actif' | Statut du r√©seau |
| client_type | text | NO | 'reseau' | Type de client |

---

## üîß D√âFINITION SQL COMPL√àTE

```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.reseau (
  reseau_id uuid NOT NULL DEFAULT gen_random_uuid(),
  organisation_id uuid NOT NULL,
  reseau_created_at timestamp with time zone NOT NULL DEFAULT now(),
  reseau_created_by uuid,
  reseau_updated_at timestamp with time zone DEFAULT now(),
  reseau_updated_by uuid,
  reseau_nom text NOT NULL,
  reseau_identite_commerciale text,
  reseau_adresse text NOT NULL,
  reseau_code_postal text NOT NULL,
  reseau_ville text NOT NULL,
  reseau_telephone text NOT NULL,
  reseau_email text NOT NULL,
  reseau_siret text NOT NULL,
  reseau_date_inscription timestamp with time zone NOT NULL DEFAULT now(),
  reseau_date_debut_abonnement timestamp with time zone,
  reseau_date_resiliation_abonnement timestamp with time zone,
  reseau_statut_abonnement text,
  reseau_plan text,
  reseau_statut_paiement text,
  reseau_abonnement_id uuid,
  reseau_brevo_connexion_id uuid,
  reseau_openai_connexion_id uuid,
  reseau_zoho_connexion_id uuid,
  client_type text NOT NULL DEFAULT 'reseau'::text,
  client_id uuid NOT NULL DEFAULT gen_random_uuid(),
  reseau_logo text,
  reseau_ressources text[],
  reseau_espace_client boolean NOT NULL DEFAULT true,
  interdit_acces_admin_presenca boolean NOT NULL DEFAULT false,
  autorisation_acces_reseau_presenca boolean NOT NULL DEFAULT true,
  reseau_statut text NOT NULL DEFAULT 'actif'::text,
  reseau_audit_log jsonb,
  reseau_ia_extensions jsonb,
  CONSTRAINT ck_client_type CHECK (client_type = 'reseau'::text),
  CONSTRAINT ck_reseau_plan CHECK ((reseau_plan = ANY (ARRAY['starter'::text, 'pro'::text, 'premium'::text])) OR reseau_plan IS NULL),
  CONSTRAINT ck_reseau_statut CHECK (reseau_statut = ANY (ARRAY['actif'::text, 'suspendu'::text, 'archive'::text])),
  CONSTRAINT ck_reseau_statut_abonnement CHECK ((reseau_statut_abonnement = ANY (ARRAY['actif'::text, 'resilie'::text, 'en_pause'::text])) OR reseau_statut_abonnement IS NULL),
  CONSTRAINT ck_reseau_statut_paiement CHECK ((reseau_statut_paiement = ANY (ARRAY['a_jour'::text, 'en_retard'::text, 'suspendu'::text])) OR reseau_statut_paiement IS NULL),
  CONSTRAINT fk_reseau_created_by FOREIGN KEY (reseau_created_by) REFERENCES users(users_id) ON DELETE SET NULL,
  CONSTRAINT fk_reseau_organisation FOREIGN KEY (organisation_id) REFERENCES organisations(organisation_id) ON DELETE CASCADE,
  CONSTRAINT fk_reseau_updated_by FOREIGN KEY (reseau_updated_by) REFERENCES users(users_id) ON DELETE SET NULL,
  CONSTRAINT reseau_pkey PRIMARY KEY (reseau_id),
  CONSTRAINT uk_reseau_email UNIQUE (reseau_email)
);
```

---

## üóÇÔ∏è CONTRAINTES

### Cl√©s primaires et √©trang√®res
- **PRIMARY KEY**: reseau_pkey (reseau_id)
- **FOREIGN KEY**: fk_reseau_organisation ‚Üí organisations(organisation_id)
- **FOREIGN KEY**: fk_reseau_created_by ‚Üí users(users_id)
- **FOREIGN KEY**: fk_reseau_updated_by ‚Üí users(users_id)
- **UNIQUE**: uk_reseau_email (reseau_email)

### Contraintes CHECK
- **ck_client_type**: client_type = 'reseau'
- **ck_reseau_plan**: Plan ('starter', 'pro', 'premium' ou NULL)
- **ck_reseau_statut**: Statut ('actif', 'suspendu', 'archive')
- **ck_reseau_statut_abonnement**: Statut abonnement ('actif', 'resilie', 'en_pause' ou NULL)
- **ck_reseau_statut_paiement**: Statut paiement ('a_jour', 'en_retard', 'suspendu' ou NULL)

---

## üìà INDEX

- **reseau_pkey**: PRIMARY KEY UNIQUE INDEX sur reseau_id
- **uk_reseau_email**: UNIQUE INDEX sur reseau_email

---

## ‚ö° TRIGGERS

#### 1. trigger_set_created_audit_fields_reseau
- **Type:** BEFORE INSERT
- **Fonction:** set_created_audit_fields_reseau()
- **Description:** D√©finit automatiquement les champs d'audit √† la cr√©ation

#### 2. trigger_update_audit_fields_reseau
- **Type:** BEFORE UPDATE
- **Fonction:** update_audit_fields_reseau()
- **Description:** Met √† jour reseau_updated_at et reseau_updated_by

---

## üîó RELATIONS ENTRE TABLES (FK)

### Relations sortantes
- **reseau.organisation_id** ‚Üí organisations.organisation_id
- **reseau.reseau_created_by** ‚Üí users.users_id
- **reseau.reseau_updated_by** ‚Üí users.users_id

### Relations entrantes
- reseau_direction.reseau_id ‚Üê reseau.reseau_id
- reseau_agence.reseau_id ‚Üê reseau.reseau_id
- reseau_agence_responsable.reseau_id ‚Üê reseau.reseau_id
- reseau_agence_collaborateur.reseau_id ‚Üê reseau.reseau_id

---

## üõ°Ô∏è S√âCURIT√â RLS

**RLS Activ√©e:** ‚úÖ OUI  
**RLS Forc√©e:** ‚ùå NON

### Policies RLS

#### 1. admin_presenca_full_access_reseau
- **Type:** ALL
- **R√¥les:** public
- **Condition:** `is_admin_presenca(auth.uid())`

#### 2. organisation_only_access_reseau
- **Type:** ALL
- **R√¥les:** public
- **Condition:** `organisation_id = get_user_organisation_id(auth.uid())`

---

## üîß FONCTIONS LI√âES

### Fonctions utilisant cette table
- **get_organisation_type()**: D√©termine le type d'organisation (reseau/agence_independante)
- **set_created_audit_fields_reseau()**: Trigger d'insertion
- **update_audit_fields_reseau()**: Trigger de mise √† jour

---

## üéØ NOTES TECHNIQUES

### Int√©gration
- **Table pivot** pour les r√©seaux dans l'√©cosyst√®me multi-tenant
- **Connexions API** : Brevo, OpenAI, Zoho via FK
- **Hi√©rarchie** : Organisation > R√©seau > Agences

### S√©curit√©
- **Isolation par organisation** via RLS
- **Audit complet** avec created_by/updated_by
- **Contraintes de validation** sur tous les statuts

### Performance
- **Index unique** sur email pour √©viter les doublons
- **Relations optimis√©es** avec users pour l'audit
- **Structure JSON** pour audit_log et ia_extensions

### Business Logic
- **Plans tarifaires** : starter, pro, premium
- **Gestion abonnement** : dates, statuts, r√©siliation
- **Contr√¥les d'acc√®s** : espace client, admin PRESENCA

*Documentation g√©n√©r√©e automatiquement le 17.08.2025*