# TABLE: abonnement_stripe

**Date de g√©n√©ration:** 17.08.2025  
**Statut:** ‚úÖ ACTIVE  
**Type:** Table technique - Gestion abonnements Stripe

---

## üìã STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Description |
|---------|------|----------|--------|-------------|
| abonnement_id | uuid | NO | gen_random_uuid() | üîë Identifiant unique |
| organisation_id | uuid | NO | - | üîó Organisation de rattachement |
| abonnement_appli_client_id | uuid | NO | - | üîó ID client application |
| abonnement_appli_souscripteur | text | NO | - | Type de souscripteur |
| abonnement_stripe_numero_abonnement_id | text | NO | - | ID abonnement Stripe |
| abonnement_stripe_numero_client_id | text | NO | - | ID client Stripe |
| abonnement_stripe_payeur_id | uuid | NO | - | üîó ID payeur |
| abonnement_stripe_payeur_type | text | NO | - | Type de payeur |
| abonnement_stripe_plan | text | NO | - | Plan Stripe souscrit |
| abonnement_stripe_debut | timestamp with time zone | NO | - | Date de d√©but |
| abonnement_stripe_terme_prevu | timestamp with time zone | YES | - | Terme pr√©vu |
| abonnement_stripe_date_resiliation | timestamp with time zone | YES | - | Date de r√©siliation |
| abonnement_stripe_statut_appli | text | NO | 'en_cours' | Statut application |
| abonnement_stripe_statut_paiement | text | YES | - | Statut paiement |
| abonnement_stripe_statut_essai | boolean | NO | false | P√©riode d'essai |
| abonnement_stripe_fin_essai | timestamp with time zone | YES | - | Fin p√©riode d'essai |
| abonnement_stripe_fractionnement | text | NO | 'mois' | Fr√©quence facturation |
| abonnement_stripe_quantite | numeric | NO | 1 | Quantit√© |
| abonnement_stripe_montant_ht | numeric | NO | - | Montant HT |
| abonnement_stripe_devise | text | NO | 'eur' | Devise |
| abonnement_stripe_tva | boolean | NO | true | TVA applicable |
| abonnement_stripe_taux_tva | numeric | YES | 20.0 | Taux TVA |
| abonnement_stripe_pays | text | NO | 'FR' | Pays |
| abonnement_stripe_raison_sociale | text | YES | - | Raison sociale |
| abonnement_stripe_siret | text | YES | - | SIRET |
| abonnement_stripe_next_echeance | timestamp with time zone | YES | - | Prochaine √©ch√©ance |
| abonnement_stripe_paiement_date | timestamp with time zone | YES | - | Date dernier paiement |
| abonnement_stripe_paiement_montant | numeric | YES | - | Montant paiement |
| abonnement_stripe_paiement_total | numeric | YES | 0 | Total pay√© |
| abonnement_stripe_paiement_reussi | numeric | YES | 0 | Paiements r√©ussis |
| abonnement_stripe_paiement_refus | numeric | YES | 0 | Paiements refus√©s |
| abonnement_stripe_facture_suspens | numeric | YES | 0 | Factures en suspens |
| abonnement_stripe_retard | boolean | NO | false | En retard |
| abonnement_stripe_last_facture | timestamp with time zone | YES | - | Derni√®re facture |
| abonnement_stripe_last_synchro | timestamp with time zone | YES | now() | Derni√®re synchro |
| abonnement_stripe_mode | text | YES | - | Mode (test/live) |
| abonnement_stripe_commentaire_presenca | text | YES | - | Commentaires PRESENCA |
| abonnement_created_at | timestamp with time zone | NO | now() | Date de cr√©ation |
| abonnement_created_by | uuid | YES | - | Cr√©√© par (utilisateur) |
| abonnement_updated_at | timestamp with time zone | NO | now() | Date de modification |
| abonnement_updated_by | uuid | YES | - | Modifi√© par (utilisateur) |

---

## ‚ö° TRIGGERS

#### 1. trigger_set_created_audit_fields_abonnement_stripe
- **Type:** BEFORE INSERT
- **Fonction:** set_created_audit_fields_abonnement_stripe()
- **Description:** D√©finit les champs d'audit √† la cr√©ation

#### 2. trigger_update_audit_fields_abonnement_stripe
- **Type:** BEFORE UPDATE
- **Fonction:** update_audit_fields_abonnement_stripe()
- **Description:** Met √† jour les champs d'audit

---

## üîó RELATIONS ENTRE TABLES (FK)

### Relations sortantes
- **abonnement_stripe.organisation_id** ‚Üí organisations.organisation_id (implicite)

### Relations entrantes
- reseau.reseau_abonnement_id ‚Üê abonnement_stripe.abonnement_id
- reseau_agence.reseau_agence_abonnement_id ‚Üê abonnement_stripe.abonnement_id
- agence_independante.agence_indep_abonnement_id ‚Üê abonnement_stripe.abonnement_id

---

## üîß FONCTIONS LI√âES

### Fonctions utilisant cette table
- **set_created_audit_fields_abonnement_stripe()**: Trigger d'insertion
- **update_audit_fields_abonnement_stripe()**: Trigger de mise √† jour

---

## üõ°Ô∏è S√âCURIT√â RLS

**RLS Activ√©e:** ‚úÖ OUI  
**RLS Forc√©e:** ‚ùå NON

### Policies RLS

#### 1. admin_presenca_full_access_abonnement_stripe
- **Type:** ALL
- **R√¥les:** authenticated
- **Condition:** `is_admin_presenca(auth.uid())`

#### 2. organisation_only_access_abonnement_stripe
- **Type:** ALL
- **R√¥les:** authenticated
- **Condition:** `organisation_id = get_user_organisation_id(auth.uid())`

---

## üéØ NOTES TECHNIQUES

### Int√©gration
- **Stripe API** : Gestion compl√®te des abonnements et facturation
- **Webhook** : Synchronisation temps r√©el avec Stripe
- **Multi-devises** : Support international avec EUR par d√©faut

### S√©curit√©
- **Donn√©es financi√®res** : Protection maximale des informations sensibles
- **Isolation** : Par organisation via RLS strict
- **Audit complet** : Triggers automatiques pour conformit√©

### Business Logic
- **Facturation fran√ßaise** : TVA, SIRET, raison sociale
- **P√©riode d'essai** : Gestion essais gratuits
- **M√©triques paiement** : Suivi r√©ussis/refus√©s/en suspens

### Performance
- **Index automatique** : Sur abonnement_id (PRIMARY KEY)
- **Numeric precision** : Calculs financiers pr√©cis
- **Relations multiples** : Liens vers tous types de clients

*Documentation g√©n√©r√©e automatiquement le 17.08.2025*