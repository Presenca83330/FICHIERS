# ANALYSE DES RÃ”LES - ARCHITECTURE ADMIN PRESENÃ‡A

**Date de gÃ©nÃ©ration:** 16.08.2025  
**Statut:** âœ… ACTIVE  
**Type:** Documentation architecture des rÃ´les systÃ¨me

---

## ğŸ¯ RÃ”LES DÃ‰FINIS DANS L'ARCHITECTURE

### HiÃ©rarchie des rÃ´les (du plus haut au plus bas privilÃ¨ge)

1. **`superadmin`** - RÃ´le supÃ©rieur (privilÃ¨ges maximum)
2. **`admin_presenca`** - RÃ´le principal admin PRESENÃ‡A
3. **`support`** - RÃ´le support technique
4. **`admin`** - RÃ´le mÃ©tier/organisation
5. **`client`** - RÃ´le standard utilisateur

---

## ğŸ“Š TABLEAU D'UTILISATION DES RÃ”LES PAR TABLE

### Table: `users` (StratÃ©gique)

| RÃ´le | Colonne | Contrainte CHECK | Fonctions associÃ©es | Usage |
|------|---------|------------------|-------------------|-------|
| `admin_presenca` | `users_role_systeme` | âœ… DÃ©fini | `is_admin_presenca()` | RLS + Redirection |
| `superadmin` | `users_role_systeme` | âœ… DÃ©fini | - | PrivilÃ¨ges maximums |
| `support` | `users_role_systeme` | âœ… DÃ©fini | - | Support technique |
| `admin` | `users_role` | âœ… DÃ©fini | - | RÃ´le mÃ©tier |
| `client` | `users_role` | âœ… DÃ©fini (dÃ©faut) | - | RÃ´le standard |

**Contraintes CHECK:**
```sql
-- users_role_check
CHECK (users_role = ANY (ARRAY['client'::text, 'admin'::text]))

-- users_role_systeme_check  
CHECK ((users_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (users_role_systeme IS NULL))
```

### Table: `utilisateurs` (StratÃ©gique)

| RÃ´le | Colonne | Contrainte CHECK | Fonctions associÃ©es | Usage |
|------|---------|------------------|-------------------|-------|
| `admin_presenca` | `utilisateur_role_systeme` | âœ… DÃ©fini | `is_admin_presenca()` | RLS Business |
| `superadmin` | `utilisateur_role_systeme` | âœ… DÃ©fini | - | PrivilÃ¨ges maximums |
| `support` | `utilisateur_role_systeme` | âœ… DÃ©fini | - | Support technique |

**Contraintes CHECK:**
```sql
-- utilisateurs_role_systeme_check
CHECK ((utilisateur_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (utilisateur_role_systeme IS NULL))
```

---

## ğŸ”§ FONCTIONS SUPABASE UTILISANT LES RÃ”LES

### Fonction: `is_admin_presenca(user_uuid uuid)`

**Type:** STABLE SECURITY DEFINER  
**Usage:** ContrÃ´le d'accÃ¨s privilÃ©giÃ©

**Tables consultÃ©es:**
- `public.users` 
  - Condition: `users_auth_id = user_uuid AND users_role_systeme = 'admin_presenca'`

**UtilisÃ©e dans les RLS de:**
- users (Admin PRESENCA full access)
- utilisateurs (Admin PRESENCA full access)
- organisations (Admin PRESENCA full access)
- Toutes les tables mÃ©tier (policies admin_presenca_full_access_*)

### Fonction: `get_current_user_role()`

**Type:** STABLE SECURITY DEFINER  
**Usage:** RÃ©cupÃ©ration du rÃ´le systÃ¨me actuel

**Tables consultÃ©es:**
- `public.users`
  - Retourne: `users_role_systeme`
  - Condition: `users_auth_id = auth.uid()`

---

## ğŸ›¡ï¸ UTILISATION DANS LES POLITIQUES RLS

### Pattern Admin PRESENÃ‡A (universel)

**Format:** `admin_presenca_full_access_[table_name]`  
**Condition:** `is_admin_presenca(auth.uid())`  
**PrivilÃ¨ges:** ALL (SELECT, INSERT, UPDATE, DELETE)

**Tables appliquÃ©es:**
- users âœ…
- utilisateurs âœ…  
- organisations âœ…
- reseau âœ…
- reseau_direction âœ…
- reseau_agence âœ…
- reseau_agence_responsable âœ…
- reseau_agence_collaborateur âœ…
- agence_independante âœ…
- agence_independante_responsable âœ…
- agence_independante_collaborateur âœ…
- brevo_connexion âœ…
- zoho_connexion âœ…
- openai_connexion âœ…
- linkedin_connexion âœ…
- facebook_connexion âœ…
- instagram_connexion âœ…
- abonnement_stripe âœ…
- 1_historique_supabase âœ…

---

## ğŸ’» UTILISATION DANS LE CODE

### Hooks stratÃ©giques

#### `useCurrentUser` - helpers.ts
```typescript
export const computeIsAdminPresenca = (user: DbUser | null): boolean =>
  (user?.users_role_systeme ?? null) === 'admin_presenca';
```

#### `useMultiTenant` - useMultiTenant.ts
```typescript
const systemRole = dbUser?.users_role_systeme as SystemRole | null;
const isAdminPresenca = systemRole === "admin_presenca";
```

#### `useAuth` - useAuth.ts
```typescript
// Redirection selon rÃ´le systÃ¨me
if (user.user_metadata?.users_role_systeme === 'admin_presenca') {
  return '/admin-presenca';
}
```

### Contextes

#### `ImpersonationContext.tsx`
```typescript
const canImpersonate = dbUser?.users_role_systeme === 'admin_presenca';
```

### Hooks utilitaires

#### `useOrganisations.ts`
```typescript
if (profileData?.users_role_systeme !== 'admin_presenca') {
  throw new Error('AccÃ¨s non autorisÃ© - admin_presenca requis');
}
```

#### `useSupabaseQuery.ts`
```typescript
isAdmin: profile?.users_role_systeme === 'admin_presenca',
```

---

## ğŸ¯ STATUT D'IMPLÃ‰MENTATION

### RÃ´les complÃ¨tement intÃ©grÃ©s âœ…

- **`admin_presenca`**: Fonction DB + RLS + Hooks + Redirections
- **`client`**: IntÃ©grÃ© dans users_role + logique mÃ©tier
- **`admin`**: IntÃ©grÃ© dans users_role + permissions organisation

### RÃ´les dÃ©finis mais pas utilisÃ©s âš ï¸

- **`superadmin`**: DÃ©fini dans contraintes CHECK uniquement
- **`support`**: DÃ©fini dans contraintes CHECK uniquement

---

## ğŸ“‹ RECOMMANDATIONS

### 1. Activation des rÃ´les manquants

**Pour `superadmin`:**
- CrÃ©er fonction `is_superadmin(user_uuid uuid)`
- Ajouter logique dans hooks
- PrivilÃ¨ges: Tout + gestion systÃ¨me

**Pour `support`:**
- CrÃ©er fonction `is_support(user_uuid uuid)`
- Permissions: Lecture seule + logs
- Interface dÃ©diÃ©e support

### 2. HiÃ©rarchie des privilÃ¨ges

```
superadmin > admin_presenca > support > admin > client
```

### 3. Interface par dÃ©faut

**Mapping recommandÃ©:**
- `superadmin` â†’ `/admin-super`
- `admin_presenca` â†’ `/admin-presenca` âœ…
- `support` â†’ `/support`
- `admin` â†’ `/admin-org` ou `/espace-client`
- `client` â†’ `/espace-client` âœ…

---

## ğŸ” TABLES DE CORRESPONDANCE

### RÃ´le systÃ¨me â†’ Tables impactÃ©es

| RÃ´le | Tables users | Tables utilisateurs | Tables mÃ©tier | Fonctions | Interfaces |
|------|-------------|-------------------|---------------|-----------|-----------|
| `superadmin` | âœ… | âœ… | - | âŒ | âŒ |
| `admin_presenca` | âœ… | âœ… | âœ… Toutes | âœ… | âœ… |
| `support` | âœ… | âœ… | - | âŒ | âŒ |
| `admin` | âœ… | âŒ | âœ… Org seulement | âŒ | âœ… |
| `client` | âœ… | âŒ | âœ… Profil seulement | âŒ | âœ… |

### Permissions effectives

| RÃ´le | Lecture | Ã‰criture | Suppression | Impersonation | Cross-Org |
|------|---------|----------|-------------|---------------|-----------|
| `superadmin` | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. |
| `admin_presenca` | âœ… Totale | âœ… Totale | âœ… Totale | âœ… Oui | âœ… Oui |
| `support` | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. | ğŸ”´ Non impl. |
| `admin` | âœ… Org uniquement | âœ… Org uniquement | âŒ Non | âŒ Non | âŒ Non |
| `client` | âœ… Profil uniquement | âœ… Profil uniquement | âŒ Non | âŒ Non | âŒ Non |

---

*Documentation gÃ©nÃ©rÃ©e automatiquement le 16.08.2025*