# ANALYSE DES RÔLES - ARCHITECTURE ADMIN PRESENÇA

**Date de génération:** 16.08.2025  
**Statut:** ✅ ACTIVE  
**Type:** Documentation architecture des rôles système

---

## 🎯 RÔLES DÉFINIS DANS L'ARCHITECTURE

### Hiérarchie des rôles (du plus haut au plus bas privilège)

1. **`superadmin`** - Rôle supérieur (privilèges maximum)
2. **`admin_presenca`** - Rôle principal admin PRESENÇA
3. **`support`** - Rôle support technique
4. **`admin`** - Rôle métier/organisation
5. **`client`** - Rôle standard utilisateur

---

## 📊 TABLEAU D'UTILISATION DES RÔLES PAR TABLE

### Table: `users` (Stratégique)

| Rôle | Colonne | Contrainte CHECK | Fonctions associées | Usage |
|------|---------|------------------|-------------------|-------|
| `admin_presenca` | `users_role_systeme` | ✅ Défini | `is_admin_presenca()` | RLS + Redirection |
| `superadmin` | `users_role_systeme` | ✅ Défini | - | Privilèges maximums |
| `support` | `users_role_systeme` | ✅ Défini | - | Support technique |
| `admin` | `users_role` | ✅ Défini | - | Rôle métier |
| `client` | `users_role` | ✅ Défini (défaut) | - | Rôle standard |

**Contraintes CHECK:**
```sql
-- users_role_check
CHECK (users_role = ANY (ARRAY['client'::text, 'admin'::text]))

-- users_role_systeme_check  
CHECK ((users_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (users_role_systeme IS NULL))
```

### Table: `utilisateurs` (Stratégique)

| Rôle | Colonne | Contrainte CHECK | Fonctions associées | Usage |
|------|---------|------------------|-------------------|-------|
| `admin_presenca` | `utilisateur_role_systeme` | ✅ Défini | `is_admin_presenca()` | RLS Business |
| `superadmin` | `utilisateur_role_systeme` | ✅ Défini | - | Privilèges maximums |
| `support` | `utilisateur_role_systeme` | ✅ Défini | - | Support technique |

**Contraintes CHECK:**
```sql
-- utilisateurs_role_systeme_check
CHECK ((utilisateur_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (utilisateur_role_systeme IS NULL))
```

---

## 🔧 FONCTIONS SUPABASE UTILISANT LES RÔLES

### Fonction: `is_admin_presenca(user_uuid uuid)`

**Type:** STABLE SECURITY DEFINER  
**Usage:** Contrôle d'accès privilégié

**Tables consultées:**
- `public.users` 
  - Condition: `users_auth_id = user_uuid AND users_role_systeme = 'admin_presenca'`

**Utilisée dans les RLS de:**
- users (Admin PRESENCA full access)
- utilisateurs (Admin PRESENCA full access)
- organisations (Admin PRESENCA full access)
- Toutes les tables métier (policies admin_presenca_full_access_*)

### Fonction: `get_current_user_role()`

**Type:** STABLE SECURITY DEFINER  
**Usage:** Récupération du rôle système actuel

**Tables consultées:**
- `public.users`
  - Retourne: `users_role_systeme`
  - Condition: `users_auth_id = auth.uid()`

---

## 🛡️ UTILISATION DANS LES POLITIQUES RLS

### Pattern Admin PRESENÇA (universel)

**Format:** `admin_presenca_full_access_[table_name]`  
**Condition:** `is_admin_presenca(auth.uid())`  
**Privilèges:** ALL (SELECT, INSERT, UPDATE, DELETE)

**Tables appliquées:**
- users ✅
- utilisateurs ✅  
- organisations ✅
- reseau ✅
- reseau_direction ✅
- reseau_agence ✅
- reseau_agence_responsable ✅
- reseau_agence_collaborateur ✅
- agence_independante ✅
- agence_independante_responsable ✅
- agence_independante_collaborateur ✅
- brevo_connexion ✅
- zoho_connexion ✅
- openai_connexion ✅
- linkedin_connexion ✅
- facebook_connexion ✅
- instagram_connexion ✅
- abonnement_stripe ✅
- 1_historique_supabase ✅

---

## 💻 UTILISATION DANS LE CODE

### Hooks stratégiques

#### `useCurrentUser` - helpers.ts
```typescript
export const computeIsAdminPresenca = (user: DbUser | null): boolean =>
  (user?.users_role_systeme ?? null) === 'admin_presenca';
```

#### `useMultiTenant` - useMultiTenant.ts
```typescript
const systemRole = dbUser?.users_role_systeme as SystemRole | null;
const isAdminPresenca = systemRole === "admin_presenca";
```

#### `useAuth` - useAuth.ts
```typescript
// Redirection selon rôle système
if (user.user_metadata?.users_role_systeme === 'admin_presenca') {
  return '/admin-presenca';
}
```

### Contextes

#### `ImpersonationContext.tsx`
```typescript
const canImpersonate = dbUser?.users_role_systeme === 'admin_presenca';
```

### Hooks utilitaires

#### `useOrganisations.ts`
```typescript
if (profileData?.users_role_systeme !== 'admin_presenca') {
  throw new Error('Accès non autorisé - admin_presenca requis');
}
```

#### `useSupabaseQuery.ts`
```typescript
isAdmin: profile?.users_role_systeme === 'admin_presenca',
```

---

## 🎯 STATUT D'IMPLÉMENTATION

### Rôles complètement intégrés ✅

- **`admin_presenca`**: Fonction DB + RLS + Hooks + Redirections
- **`client`**: Intégré dans users_role + logique métier
- **`admin`**: Intégré dans users_role + permissions organisation

### Rôles définis mais pas utilisés ⚠️

- **`superadmin`**: Défini dans contraintes CHECK uniquement
- **`support`**: Défini dans contraintes CHECK uniquement

---

## 📋 RECOMMANDATIONS

### 1. Activation des rôles manquants

**Pour `superadmin`:**
- Créer fonction `is_superadmin(user_uuid uuid)`
- Ajouter logique dans hooks
- Privilèges: Tout + gestion système

**Pour `support`:**
- Créer fonction `is_support(user_uuid uuid)`
- Permissions: Lecture seule + logs
- Interface dédiée support

### 2. Hiérarchie des privilèges

```
superadmin > admin_presenca > support > admin > client
```

### 3. Interface par défaut

**Mapping recommandé:**
- `superadmin` → `/admin-super`
- `admin_presenca` → `/admin-presenca` ✅
- `support` → `/support`
- `admin` → `/admin-org` ou `/espace-client`
- `client` → `/espace-client` ✅

---

## 🔍 TABLES DE CORRESPONDANCE

### Rôle système → Tables impactées

| Rôle | Tables users | Tables utilisateurs | Tables métier | Fonctions | Interfaces |
|------|-------------|-------------------|---------------|-----------|-----------|
| `superadmin` | ✅ | ✅ | - | ❌ | ❌ |
| `admin_presenca` | ✅ | ✅ | ✅ Toutes | ✅ | ✅ |
| `support` | ✅ | ✅ | - | ❌ | ❌ |
| `admin` | ✅ | ❌ | ✅ Org seulement | ❌ | ✅ |
| `client` | ✅ | ❌ | ✅ Profil seulement | ❌ | ✅ |

### Permissions effectives

| Rôle | Lecture | Écriture | Suppression | Impersonation | Cross-Org |
|------|---------|----------|-------------|---------------|-----------|
| `superadmin` | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. |
| `admin_presenca` | ✅ Totale | ✅ Totale | ✅ Totale | ✅ Oui | ✅ Oui |
| `support` | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. | 🔴 Non impl. |
| `admin` | ✅ Org uniquement | ✅ Org uniquement | ❌ Non | ❌ Non | ❌ Non |
| `client` | ✅ Profil uniquement | ✅ Profil uniquement | ❌ Non | ❌ Non | ❌ Non |

---

*Documentation générée automatiquement le 16.08.2025*