# TABLE: utilisateurs

**Date de g√©n√©ration:** 17.08.2025  
**Statut:** ‚úÖ ACTIVE  
**Type:** Table strat√©gique - Utilisateurs m√©tier

---

## üìã STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Description |
|---------|------|----------|--------|-------------|
| utilisateur_id | uuid | NO | gen_random_uuid() | üîë Identifiant unique |
| utilisateur_organisation_id | uuid | NO | - | üîó Organisation de rattachement |
| utilisateur_email | text | NO | - | Email utilisateur (unique) |
| utilisateur_auth_uid | uuid | NO | - | üîó R√©f√©rence auth.users |
| utilisateur_type_compte | text | NO | - | Type de compte m√©tier |
| utilisateur_date_inscription | timestamp with time zone | NO | now() | Date d'inscription |
| utilisateur_statut | text | NO | 'actif' | Statut du compte |
| utilisateur_role_systeme | text | YES | - | R√¥le syst√®me global |

---

## üîß D√âFINITION SQL COMPL√àTE

```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.utilisateurs (
  utilisateur_id uuid NOT NULL DEFAULT gen_random_uuid(),
  utilisateur_organisation_id uuid NOT NULL,
  utilisateur_email text NOT NULL,
  utilisateur_auth_uid uuid NOT NULL,
  utilisateur_type_compte text NOT NULL,
  utilisateur_date_inscription timestamp with time zone NOT NULL DEFAULT now(),
  utilisateur_statut text NOT NULL DEFAULT 'actif'::text,
  utilisateur_role_systeme text,
  CONSTRAINT utilisateurs_pkey PRIMARY KEY (utilisateur_id),
  CONSTRAINT utilisateurs_utilisateur_auth_uid_key UNIQUE (utilisateur_auth_uid),
  CONSTRAINT utilisateurs_utilisateur_email_key UNIQUE (utilisateur_email),
  CONSTRAINT utilisateurs_utilisateur_role_systeme_check CHECK ((utilisateur_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (utilisateur_role_systeme IS NULL)),
  CONSTRAINT utilisateurs_utilisateur_statut_check CHECK (utilisateur_statut = ANY (ARRAY['actif'::text, 'suspendu'::text, 'supprime'::text, 'en_attente'::text])),
  CONSTRAINT utilisateurs_utilisateur_type_compte_check CHECK (utilisateur_type_compte = ANY (ARRAY['reseau'::text, 'agence_independante'::text]))
);
```

---

## üóÇÔ∏è CONTRAINTES

### Cl√©s primaires et √©trang√®res
- **PRIMARY KEY**: utilisateurs_pkey (utilisateur_id)
- **UNIQUE**: utilisateurs_utilisateur_auth_uid_key (utilisateur_auth_uid)
- **UNIQUE**: utilisateurs_utilisateur_email_key (utilisateur_email)

### Contraintes CHECK
- **utilisateurs_utilisateur_type_compte_check**: Type ('reseau', 'agence_independante')
- **utilisateurs_utilisateur_statut_check**: Statut ('actif', 'suspendu', 'supprime', 'en_attente')
- **utilisateurs_utilisateur_role_systeme_check**: R√¥le syst√®me ('admin_presenca', 'superadmin', 'support' ou NULL)

---

## üìà INDEX

- **utilisateurs_pkey**: PRIMARY KEY UNIQUE INDEX sur utilisateur_id
- **utilisateurs_utilisateur_auth_uid_key**: UNIQUE INDEX sur utilisateur_auth_uid
- **utilisateurs_utilisateur_email_key**: UNIQUE INDEX sur utilisateur_email

---

## ‚ö° TRIGGERS

#### 1. sync_utilisateurs_to_users
- **Type:** AFTER UPDATE
- **Fonction:** sync_users_utilisateurs()
- **Description:** Synchronise vers la table users

#### 2. utilisateurs_insert_audit
- **Type:** BEFORE INSERT
- **Fonction:** set_created_audit_fields_utilisateurs()
- **Description:** D√©finit les champs d'audit

#### 3. utilisateurs_update_audit
- **Type:** BEFORE UPDATE
- **Fonction:** update_audit_fields_utilisateurs()
- **Description:** Met √† jour les champs d'audit

---

## üîó RELATIONS ENTRE TABLES (FK)

### Relations sortantes
- **utilisateurs.utilisateur_organisation_id** ‚Üí organisations.organisation_id (implicite)
- **utilisateurs.utilisateur_auth_uid** ‚Üí auth.users.id (implicite)

---

## üõ°Ô∏è S√âCURIT√â RLS

**RLS Activ√©e:** ‚úÖ OUI  
**RLS Forc√©e:** ‚ùå NON

### Policies RLS

#### 1. Admin PRESENCA full access utilisateurs
- **Type:** ALL
- **R√¥les:** public
- **Condition:** `is_admin_presenca(auth.uid())`

#### 2. Users can view their own profile
- **Type:** SELECT
- **R√¥les:** public
- **Condition:** `utilisateur_auth_uid = auth.uid()`

#### 3. Same organization users can view
- **Type:** SELECT
- **R√¥les:** public
- **Condition:** `utilisateur_organisation_id IN (SELECT u.utilisateur_organisation_id FROM utilisateurs u WHERE u.utilisateur_auth_uid = auth.uid())`

#### 4. Users can update their own profile
- **Type:** UPDATE
- **R√¥les:** public
- **Condition:** `utilisateur_auth_uid = auth.uid()`

---

## üîß FONCTIONS LI√âES

### Fonctions utilisant cette table
- **set_created_audit_fields_utilisateurs()**: Trigger d'insertion
- **update_audit_fields_utilisateurs()**: Trigger de mise √† jour

---

## üéØ NOTES TECHNIQUES

### Int√©gration
- **Table m√©tier**: Version business de users, orient√©e client
- **Bridge Auth**: Lien avec auth.users via utilisateur_auth_uid
- **Type sp√©cialis√©**: Distinction reseau/agence_independante

### S√©curit√©
- **Isolation organisation**: Politique RLS par organisation
- **Auto-acc√®s**: Utilisateurs voient leur propre profil
- **Same-org visibility**: Utilisateurs de m√™me organisation se voient
- **Email unique**: Contrainte syst√®me d'unicit√©

### Performance
- **Triple index**: utilisateur_id, auth_uid, email tous index√©s
- **Relations implicites**: FK vers organisations et auth.users
- **Requ√™tes optimis√©es**: Policies RLS efficaces

### Business Logic
- **Profil client**: Version m√©tier du profil utilisateur
- **Type compte**: D√©termine les fonctionnalit√©s disponibles
- **Statuts lifecycle**: en_attente > actif > suspendu/supprime
- **R√¥le syst√®me**: Extension pour privil√®ges globaux

*Documentation g√©n√©r√©e automatiquement le 14.08.2025*