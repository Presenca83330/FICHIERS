# Documentation Table: organisations

**Date de g√©n√©ration:** 17/01/2025  
**Statut:** actif  
**Type:** strat√©gique

---

## 1. D√âFINITION SQL
```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.organisations (
  organisation_id uuid NOT NULL DEFAULT gen_random_uuid(),
  organisation_nom text NOT NULL,
  organisation_siret text,
  organisation_identite_commerciale text,
  organisation_adresse text,
  organisation_code_postal text,
  organisation_ville text,
  organisation_telephone text,
  organisation_email text,
  organisation_plan_stripe text,
  organisation_statut_compte text,
  organisation_statut_paiement text,
  organisation_date_creation timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT check_organisation_statut_compte CHECK ((organisation_statut_compte = ANY (ARRAY['actif'::text, 'suspendu'::text, 'desactive'::text])) OR organisation_statut_compte IS NULL),
  CONSTRAINT check_organisation_statut_paiement CHECK ((organisation_statut_paiement = ANY (ARRAY['a_jour'::text, 'en_retard'::text, 'annule'::text])) OR organisation_statut_paiement IS NULL),
  CONSTRAINT organisations_organisation_statut_compte_check CHECK ((organisation_statut_compte = ANY (ARRAY['actif'::text, 'suspendu'::text, 'desactive'::text])) OR organisation_statut_compte IS NULL),
  CONSTRAINT organisations_organisation_statut_paiement_check CHECK ((organisation_statut_paiement = ANY (ARRAY['a_jour'::text, 'en_retard'::text, 'annule'::text])) OR organisation_statut_paiement IS NULL),
  CONSTRAINT organisations_pkey PRIMARY KEY (organisation_id)
);
CREATE UNIQUE INDEX organisations_pkey ON public.organisations USING btree (organisation_id)
```

---

## 2. STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | D√©faut | Description |
|---------|------|----------|--------|-------------|
| organisation_id | uuid | Non | gen_random_uuid() | Identifiant unique de l'organisation |
| organisation_nom | text | Non | - | Nom officiel de l'organisation |
| organisation_siret | text | Oui | - | Num√©ro SIRET de l'organisation |
| organisation_identite_commerciale | text | Oui | - | Nom commercial de l'organisation |
| organisation_adresse | text | Oui | - | Adresse physique |
| organisation_code_postal | text | Oui | - | Code postal |
| organisation_ville | text | Oui | - | Ville |
| organisation_telephone | text | Oui | - | Num√©ro de t√©l√©phone principal |
| organisation_email | text | Oui | - | Email de contact principal |
| organisation_plan_stripe | text | Oui | - | Plan d'abonnement Stripe |
| organisation_statut_compte | text | Oui | - | Statut du compte (actif, suspendu, desactive) |
| organisation_statut_paiement | text | Oui | - | Statut des paiements (a_jour, en_retard, annule) |
| organisation_date_creation | timestamp with time zone | Non | now() | Date et heure de cr√©ation |

---

## 3. CONTRAINTES
- **PRIMARY KEY**: organisations_pkey (organisation_id)
- **CHECK**: check_organisation_statut_compte - Valide les statuts de compte
- **CHECK**: check_organisation_statut_paiement - Valide les statuts de paiement
- **CHECK**: organisations_organisation_statut_compte_check - Contrainte duplicate pour statut compte
- **CHECK**: organisations_organisation_statut_paiement_check - Contrainte duplicate pour statut paiement

---

## 4. INDEX
- **organisations_pkey**: CREATE UNIQUE INDEX organisations_pkey ON public.organisations USING btree (organisation_id)

---

## 5. TRIGGERS
- **organisations_insert_audit** (BEFORE INSERT): EXECUTE FUNCTION set_created_audit_fields_organisations()
- **organisations_update_audit** (BEFORE UPDATE): EXECUTE FUNCTION update_audit_fields_organisations()

---

## 6. RELATIONS ENTRE TABLES (FK)
La table organisations est une table de r√©f√©rence centrale utilis√©e par :
- users.users_organisation_id ‚Üí organisations.organisation_id
- reseau.organisation_id ‚Üí organisations.organisation_id
- reseau_direction.organisation_id ‚Üí organisations.organisation_id
- reseau_agence.organisation_id ‚Üí organisations.organisation_id
- reseau_agence_responsable.organisation_id ‚Üí organisations.organisation_id
- reseau_agence_collaborateur.organisation_id ‚Üí organisations.organisation_id
- agence_independante.organisation_id ‚Üí organisations.organisation_id
- agence_independante_responsable.organisation_id ‚Üí organisations.organisation_id
- agence_independante_collaborateur.organisation_id ‚Üí organisations.organisation_id
- brevo_connexion.organisation_id ‚Üí organisations.organisation_id
- zoho_connexion.organisation_id ‚Üí organisations.organisation_id
- openai_connexion.organisation_id ‚Üí organisations.organisation_id
- linkedin_connexion.organisation_id ‚Üí organisations.organisation_id
- facebook_connexion.organisation_id ‚Üí organisations.organisation_id
- instagram_connexion.organisation_id ‚Üí organisations.organisation_id
- abonnement_stripe.organisation_id ‚Üí organisations.organisation_id
- 1_historique_supabase.organisation_id ‚Üí organisations.organisation_id

---

## 7. S√âCURIT√â RLS
**RLS Activ√©**: ‚úÖ OUI

### Policies actives:
- **Admin PRESENCA full access organisations** (ALL): Acc√®s complet pour les administrateurs PRESENCA
- **organisations_delete_admin_only** (DELETE): Suppression r√©serv√©e aux admins uniquement
- **organisations_insert_admin_only** (INSERT): Cr√©ation r√©serv√©e aux admins uniquement
- **organisations_select_by_org** (SELECT): Lecture par organisation ou admin
- **organisations_update_by_org** (UPDATE): Modification par organisation ou admin

---

## üîß FONCTIONS LI√âES
**Fonctions utilisant cette table**

- **get_user_organisation_id()**: R√©cup√®re l'ID d'organisation d'un utilisateur
- **get_organisation_type()**: D√©termine le type d'organisation (reseau, agence_independante)
- **get_current_user_organisation()**: R√©cup√®re l'organisation de l'utilisateur connect√©
- **set_created_audit_fields_organisations()**: Trigger d'insertion pour audit
- **update_audit_fields_organisations()**: Trigger de mise √† jour pour audit

---

## 9. NOTES TECHNIQUES
- **Derni√®re mise √† jour:** 17/01/2025
- **Source:** Supabase Database (temps r√©el)
- **G√©n√©rateur:** Lovable AI Documentation Tool (enrichi)
- **Fichier:** generate-table.js

### Points importants:
- **Table centrale**: Hub principal pour l'isolation multi-tenant
- **Contraintes dupliqu√©es**: Pr√©sence de contraintes CHECK en double (√† nettoyer)
- **S√©curit√© robuste**: RLS activ√© avec policies granulaires
- **Int√©gration Stripe**: Gestion des plans et statuts de paiement
- **Audit complet**: Triggers automatiques pour tra√ßabilit√©