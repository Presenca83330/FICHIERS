# TABLE: users

**Date de génération:** 17.08.2025  
**Statut:** ✅ ACTIVE  
**Type:** Table stratégique - Utilisateurs système

---

## 📋 STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | Défaut | Description |
|---------|------|----------|--------|-------------|
| users_id | uuid | NO | gen_random_uuid() | 🔑 Identifiant unique |
| users_auth_id | uuid | NO | - | 🔗 Référence auth.users |
| users_email | text | NO | - | Email utilisateur (unique) |
| users_nom | text | NO | - | Nom de famille |
| users_prenom | text | NO | - | Prénom |
| users_telephone | text | YES | - | Numéro de téléphone |
| users_organisation_id | uuid | YES | - | 🔗 Organisation de rattachement |
| users_role | text | NO | 'client' | Rôle utilisateur |
| users_role_systeme | text | YES | - | Rôle système avancé |
| users_interface_par_defaut | text | YES | 'client_espace' | Interface par défaut |
| users_created_at | timestamp with time zone | NO | now() | Date de création |

---

## 🔧 DÉFINITION SQL COMPLÈTE

```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.users (
  users_id uuid NOT NULL DEFAULT gen_random_uuid(),
  users_auth_id uuid NOT NULL,
  users_organisation_id uuid,
  users_created_at timestamp with time zone NOT NULL DEFAULT now(),
  users_email text NOT NULL,
  users_nom text NOT NULL,
  users_prenom text NOT NULL,
  users_telephone text,
  users_role text NOT NULL DEFAULT 'client'::text,
  users_role_systeme text,
  users_interface_par_defaut text DEFAULT 'client_espace'::text,
  CONSTRAINT users_pkey PRIMARY KEY (users_id),
  CONSTRAINT users_users_auth_id_key UNIQUE (users_auth_id),
  CONSTRAINT users_users_email_key UNIQUE (users_email),
  CONSTRAINT users_users_interface_par_defaut_check CHECK (users_interface_par_defaut = ANY (ARRAY['client_espace'::text, 'admin_presenca'::text])),
  CONSTRAINT users_users_role_check CHECK (users_role = ANY (ARRAY['client'::text, 'admin'::text])),
  CONSTRAINT users_users_role_systeme_check CHECK ((users_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (users_role_systeme IS NULL))
);
```

---

## 🗂️ CONTRAINTES

### Clés primaires et étrangères
- **PRIMARY KEY**: users_pkey (users_id)
- **UNIQUE**: users_users_auth_id_key (users_auth_id)
- **UNIQUE**: users_users_email_key (users_email)

### Contraintes CHECK
- **users_users_role_check**: Rôle ('client', 'admin')
- **users_users_role_systeme_check**: Rôle système ('admin_presenca', 'superadmin', 'support' ou NULL)
- **users_users_interface_par_defaut_check**: Interface ('client_espace', 'admin_presenca')

---

## 📈 INDEX

- **users_pkey**: PRIMARY KEY UNIQUE INDEX sur users_id
- **users_users_auth_id_key**: UNIQUE INDEX sur users_auth_id
- **users_users_email_key**: UNIQUE INDEX sur users_email

---

## ⚡ TRIGGERS

#### 1. trigger_set_created_audit_fields_users
- **Type:** BEFORE INSERT
- **Fonction:** set_created_audit_fields_users()
- **Description:** Définit automatiquement users_created_at

#### 2. trigger_update_audit_fields_users
- **Type:** BEFORE UPDATE
- **Fonction:** update_audit_fields_users()
- **Description:** Trigger de mise à jour (pas de champs modifiés)

#### 3. on_auth_user_created
- **Type:** AFTER INSERT sur auth.users
- **Fonction:** handle_new_user()
- **Description:** Crée automatiquement un profil dans public.users

---

## 🔗 RELATIONS ENTRE TABLES (FK)

### Relations sortantes
- **users.users_auth_id** → auth.users.id (implicite Supabase)
- **users.users_organisation_id** → organisations.organisation_id (implicite)

### Relations entrantes
- reseau.reseau_created_by ← users.users_id
- reseau.reseau_updated_by ← users.users_id
- reseau_direction.reseau_direction_created_by ← users.users_id
- reseau_direction.reseau_direction_updated_by ← users.users_id
- reseau_direction.reseau_direction_utilisateur_id ← users.users_id
- reseau_agence.reseau_agence_created_by ← users.users_id
- reseau_agence.reseau_agence_updated_by ← users.users_id
- reseau_agence_responsable.reseau_agence_responsable_utilisateur_id ← users.users_id
- reseau_agence_collaborateur.reseau_agence_collaborateur_utilisateur_id ← users.users_id
- agence_independante.agence_indep_created_by ← users.users_id
- agence_independante.agence_indep_updated_by ← users.users_id
- agence_independante_responsable.agence_indep_responsable_utilisateur_id ← users.users_id
- agence_independante_collaborateur.agence_indep_collaborateur_utilisateur_id ← users.users_id

---

## 🛡️ SÉCURITÉ RLS

**RLS Activée:** ✅ OUI  
**RLS Forcée:** ❌ NON

### Policies RLS

#### 1. Admin PRESENCA full access
- **Type:** ALL
- **Rôles:** public
- **Condition:** `is_admin_presenca(auth.uid())`

#### 2. Users can view their own profile
- **Type:** SELECT
- **Rôles:** public
- **Condition:** `users_auth_id = auth.uid()`

#### 3. Users can update their own profile
- **Type:** UPDATE
- **Rôles:** public
- **Condition:** `users_auth_id = auth.uid()`

---

## 🔧 FONCTIONS LIÉES

### Fonctions utilisant cette table
- **get_user_organisation_id()**: Récupère l'organisation d'un utilisateur
- **is_admin_presenca()**: Vérifie si un utilisateur est admin PRESENCA
- **get_current_user_role()**: Récupère le rôle système de l'utilisateur connecté
- **handle_new_user()**: Créé automatiquement le profil lors de l'inscription
- **set_created_audit_fields_users()**: Trigger d'insertion
- **update_audit_fields_users()**: Trigger de mise à jour

---

## 🎯 NOTES TECHNIQUES

### Intégration
- **Bridge Supabase Auth**: Lien avec auth.users via users_auth_id
- **Multi-tenant**: Organisation_id pour l'isolation
- **Profils automatiques**: Création via trigger sur auth.users

### Sécurité
- **Isolation stricte**: RLS par utilisateur connecté
- **Admin privilégié**: Accès complet pour admin_presenca
- **Email unique**: Contrainte d'unicité système
- **Rôles validés**: Contraintes CHECK sur tous les rôles

### Performance
- **Index multiples**: users_id, auth_id, email tous indexés
- **Relations optimisées**: FK implicites vers auth et organisations
- **Trigger efficace**: Création automatique de profil

### Business Logic
- **Hiérarchie des rôles**: client < admin < admin_presenca < superadmin
- **Interface adaptative**: Redirection selon le rôle
- **Support multi-organisation**: Organisation_id nullable pour flexibilité
- **Audit simple**: Seule la création est trackée

*Documentation générée automatiquement le 14.08.2025*