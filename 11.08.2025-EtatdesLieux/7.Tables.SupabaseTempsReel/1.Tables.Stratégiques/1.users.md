# TABLE: users

**Date de gÃ©nÃ©ration:** 17.08.2025  
**Statut:** âœ… ACTIVE  
**Type:** Table stratÃ©gique - Utilisateurs systÃ¨me

---

## ğŸ“‹ STRUCTURE DE LA TABLE

| Colonne | Type | Nullable | DÃ©faut | Description |
|---------|------|----------|--------|-------------|
| users_id | uuid | NO | gen_random_uuid() | ğŸ”‘ Identifiant unique |
| users_auth_id | uuid | NO | - | ğŸ”— RÃ©fÃ©rence auth.users |
| users_email | text | NO | - | Email utilisateur (unique) |
| users_nom | text | NO | - | Nom de famille |
| users_prenom | text | NO | - | PrÃ©nom |
| users_telephone | text | YES | - | NumÃ©ro de tÃ©lÃ©phone |
| users_organisation_id | uuid | YES | - | ğŸ”— Organisation de rattachement |
| users_role | text | NO | 'client' | RÃ´le utilisateur |
| users_role_systeme | text | YES | - | RÃ´le systÃ¨me avancÃ© |
| users_interface_par_defaut | text | YES | 'client_espace' | Interface par dÃ©faut |
| users_created_at | timestamp with time zone | NO | now() | Date de crÃ©ation |

---

## ğŸ”§ DÃ‰FINITION SQL COMPLÃˆTE

```sql
/* SQL Definition generated from catalogs */
/* Owner: postgres | Tablespace: pg_default | RLS: enabled */

CREATE TABLE public.users (
  users_id uuid NOT NULL DEFAULT gen_random_uuid(),
  users_auth_id uuid NOT NULL,
  users_organisation_id uuid,
  users_created_at timestamp with time zone NOT NULL DEFAULT now(),
  users_email text NOT NULL,
  users_nom text NOT NULL,
  users_prenom text NOT NULL,
  users_telephone text,
  users_role text NOT NULL DEFAULT 'client'::text,
  users_role_systeme text,
  users_interface_par_defaut text DEFAULT 'client_espace'::text,
  CONSTRAINT users_pkey PRIMARY KEY (users_id),
  CONSTRAINT users_users_auth_id_key UNIQUE (users_auth_id),
  CONSTRAINT users_users_email_key UNIQUE (users_email),
  CONSTRAINT users_users_interface_par_defaut_check CHECK (users_interface_par_defaut = ANY (ARRAY['client_espace'::text, 'admin_presenca'::text])),
  CONSTRAINT users_users_role_check CHECK (users_role = ANY (ARRAY['client'::text, 'admin'::text])),
  CONSTRAINT users_users_role_systeme_check CHECK ((users_role_systeme = ANY (ARRAY['admin_presenca'::text, 'superadmin'::text, 'support'::text])) OR (users_role_systeme IS NULL))
);
```

---

## ğŸ—‚ï¸ CONTRAINTES

### ClÃ©s primaires et Ã©trangÃ¨res
- **PRIMARY KEY**: users_pkey (users_id)
- **UNIQUE**: users_users_auth_id_key (users_auth_id)
- **UNIQUE**: users_users_email_key (users_email)

### Contraintes CHECK
- **users_users_role_check**: RÃ´le ('client', 'admin')
- **users_users_role_systeme_check**: RÃ´le systÃ¨me ('admin_presenca', 'superadmin', 'support' ou NULL)
- **users_users_interface_par_defaut_check**: Interface ('client_espace', 'admin_presenca')

---

## ğŸ“ˆ INDEX

- **users_pkey**: PRIMARY KEY UNIQUE INDEX sur users_id
- **users_users_auth_id_key**: UNIQUE INDEX sur users_auth_id
- **users_users_email_key**: UNIQUE INDEX sur users_email

---

## âš¡ TRIGGERS

#### 1. trigger_set_created_audit_fields_users
- **Type:** BEFORE INSERT
- **Fonction:** set_created_audit_fields_users()
- **Description:** DÃ©finit automatiquement users_created_at

#### 2. trigger_update_audit_fields_users
- **Type:** BEFORE UPDATE
- **Fonction:** update_audit_fields_users()
- **Description:** Trigger de mise Ã  jour (pas de champs modifiÃ©s)

#### 3. on_auth_user_created
- **Type:** AFTER INSERT sur auth.users
- **Fonction:** handle_new_user()
- **Description:** CrÃ©e automatiquement un profil dans public.users

---

## ğŸ”— RELATIONS ENTRE TABLES (FK)

### Relations sortantes
- **users.users_auth_id** â†’ auth.users.id (implicite Supabase)
- **users.users_organisation_id** â†’ organisations.organisation_id (implicite)

### Relations entrantes
- reseau.reseau_created_by â† users.users_id
- reseau.reseau_updated_by â† users.users_id
- reseau_direction.reseau_direction_created_by â† users.users_id
- reseau_direction.reseau_direction_updated_by â† users.users_id
- reseau_direction.reseau_direction_utilisateur_id â† users.users_id
- reseau_agence.reseau_agence_created_by â† users.users_id
- reseau_agence.reseau_agence_updated_by â† users.users_id
- reseau_agence_responsable.reseau_agence_responsable_utilisateur_id â† users.users_id
- reseau_agence_collaborateur.reseau_agence_collaborateur_utilisateur_id â† users.users_id
- agence_independante.agence_indep_created_by â† users.users_id
- agence_independante.agence_indep_updated_by â† users.users_id
- agence_independante_responsable.agence_indep_responsable_utilisateur_id â† users.users_id
- agence_independante_collaborateur.agence_indep_collaborateur_utilisateur_id â† users.users_id

---

## ğŸ›¡ï¸ SÃ‰CURITÃ‰ RLS

**RLS ActivÃ©e:** âœ… OUI  
**RLS ForcÃ©e:** âŒ NON

### Policies RLS

#### 1. Admin PRESENCA full access
- **Type:** ALL
- **RÃ´les:** public
- **Condition:** `is_admin_presenca(auth.uid())`

#### 2. Users can view their own profile
- **Type:** SELECT
- **RÃ´les:** public
- **Condition:** `users_auth_id = auth.uid()`

#### 3. Users can update their own profile
- **Type:** UPDATE
- **RÃ´les:** public
- **Condition:** `users_auth_id = auth.uid()`

---

## ğŸ”§ FONCTIONS LIÃ‰ES

### Fonctions utilisant cette table
- **get_user_organisation_id()**: RÃ©cupÃ¨re l'organisation d'un utilisateur
- **is_admin_presenca()**: VÃ©rifie si un utilisateur est admin PRESENCA
- **get_current_user_role()**: RÃ©cupÃ¨re le rÃ´le systÃ¨me de l'utilisateur connectÃ©
- **handle_new_user()**: CrÃ©Ã© automatiquement le profil lors de l'inscription
- **set_created_audit_fields_users()**: Trigger d'insertion
- **update_audit_fields_users()**: Trigger de mise Ã  jour

---

## ğŸ¯ NOTES TECHNIQUES

### IntÃ©gration
- **Bridge Supabase Auth**: Lien avec auth.users via users_auth_id
- **Multi-tenant**: Organisation_id pour l'isolation
- **Profils automatiques**: CrÃ©ation via trigger sur auth.users

### SÃ©curitÃ©
- **Isolation stricte**: RLS par utilisateur connectÃ©
- **Admin privilÃ©giÃ©**: AccÃ¨s complet pour admin_presenca
- **Email unique**: Contrainte d'unicitÃ© systÃ¨me
- **RÃ´les validÃ©s**: Contraintes CHECK sur tous les rÃ´les

### Performance
- **Index multiples**: users_id, auth_id, email tous indexÃ©s
- **Relations optimisÃ©es**: FK implicites vers auth et organisations
- **Trigger efficace**: CrÃ©ation automatique de profil

### Business Logic
- **HiÃ©rarchie des rÃ´les**: client < admin < admin_presenca < superadmin
- **Interface adaptative**: Redirection selon le rÃ´le
- **Support multi-organisation**: Organisation_id nullable pour flexibilitÃ©
- **Audit simple**: Seule la crÃ©ation est trackÃ©e

*Documentation gÃ©nÃ©rÃ©e automatiquement le 14.08.2025*