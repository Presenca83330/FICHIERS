# RELATIONS-BUSINESS-ENTRE-TABLES â€“ LeadGenAI AdBuilder (Version corrigÃ©e)

## 1. VUE Dâ€™ENSEMBLE STRATÃ‰GIQUE
LeadGenAI AdBuilder repose sur une architecture multi-tenant cloisonnÃ©e. Chaque utilisateur appartient obligatoirement Ã  une organisation (rÃ©seau ou agence indÃ©pendante). La table pivot **utilisateurs** incarne le profil mÃ©tier enrichi de chaque compte connectÃ©.

En rÃ©sumÃ© :
- **auth.users** = connexion technique (Supabase).
- **users** = profil systÃ¨me reliÃ© Ã  auth.users.
- **utilisateurs** = profil mÃ©tier pivot enrichi.
- **organisations** = cloisonnement tenant.
- Toutes les tables mÃ©tiers (rÃ©seau, agences, responsables, collaborateurs) sâ€™appuient sur ce triptyque.

---

## 2. TABLES ORGANISATIONNELLES

### 2.1 organisations
- Contient tous les clients : rÃ©seaux et agences indÃ©pendantes.
- Chaque organisation a un `organisation_id` unique.
- Sert de clÃ© de cloisonnement dans toutes les policies RLS.

### 2.2 auth.users (Supabase)
- Table systÃ¨me gÃ©rÃ©e par Supabase (email, provider, UID).
- Purement technique : aucune logique mÃ©tier dedans.

### 2.3 users (miroir systÃ¨me)
- ReliÃ©e 1:1 Ã  `auth.users` via `users.users_auth_id â†’ auth.users.id`.
- Contient les infos systÃ¨me et organisationnelles : email, rÃ´le (`client`/`admin`), rÃ´le systÃ¨me (`admin_presenca`, `superadmin`, `support`), interface par dÃ©faut, organisation_id.
- Sert de pivot interne pour toutes les FK de ton modÃ¨le.

### 2.4 utilisateurs (profil mÃ©tier)
- Profil mÃ©tier obligatoire reliÃ© Ã  `auth.users` via `utilisateurs.utilisateur_auth_uid â†’ auth.users.id`.
- Champs : prÃ©nom, nom, rÃ´le mÃ©tier (responsable/collaborateur), type de compte (reseau/agence_independante), tÃ©lÃ©phone, statut, organisation_id.
- Câ€™est ici que tout le mÃ©tier sâ€™articule (accÃ¨s, affichage, hiÃ©rarchie).

---

## 3. RELATION USERS â†” UTILISATEURS
- Relation stricte 1:1 mais **via `auth.users`** :
  - `users.users_auth_id â†’ auth.users.id`
  - `utilisateurs.utilisateur_auth_uid â†’ auth.users.id`
- Contrainte UNIQUE : 1 entrÃ©e `auth.users` = 1 ligne `users` = 1 ligne `utilisateurs`.
- La suppression dâ€™un `auth.users` entraÃ®ne la suppression en cascade des entrÃ©es `users` et `utilisateurs` correspondantes.
- Tous les accÃ¨s Lovable et multi-tenant passent par **utilisateurs**.

---

## 4. STRUCTURES HIÃ‰RARCHIQUES

### 4.1 RÃ©seau
```
RÃ‰SEAU (reseau)
â”œâ”€â”€ DIRECTION RÃ‰SEAU (reseau_direction)
â””â”€â”€ AGENCES RÃ‰SEAU (reseau_agence)
    â”œâ”€â”€ RESPONSABLE AGENCE (reseau_agence_responsable)
    â””â”€â”€ COLLABORATEURS (reseau_agence_collaborateur)
```
- Un rÃ©seau (`reseau`) est une organisation.
- Ses agences (`reseau_agence`) sont rattachÃ©es au mÃªme `organisation_id`.
- Chaque responsable ou collaborateur est un utilisateur.

### 4.2 Agence indÃ©pendante
```
AGENCE INDÃ‰PENDANTE (agence_independante)
â”œâ”€â”€ RESPONSABLE (agence_independante_responsable)
â””â”€â”€ COLLABORATEURS (agence_independante_collaborateur)
```
- Chaque agence indÃ©pendante est une organisation.
- Ses responsables et collaborateurs appartiennent Ã  cette organisation_id.

---

## 5. RELATIONS CLÃ‰S
- `utilisateurs.utilisateur_organisation_id â†’ organisations.organisation_id` (pivot multi-tenant).
- `reseau_agence_responsable.utilisateur_id â†’ utilisateurs.utilisateur_id`.
- `reseau_agence_collaborateur.utilisateur_id â†’ utilisateurs.utilisateur_id`.
- `agence_independante_responsable.utilisateur_id â†’ utilisateurs.utilisateur_id`.
- `agence_independante_collaborateur.utilisateur_id â†’ utilisateurs.utilisateur_id`.

Ce schÃ©ma garantit que tout utilisateur mÃ©tier est rattachÃ© Ã  une organisation et cloisonnÃ© par RLS.

---

## 6. INTÃ‰GRATIONS EXTERNES

### 6.1 Marketing / CRM / IA
- `brevo_connexion` (Emailing).
- `zoho_connexion` (CRM).
- `openai_connexion` (IA rÃ©daction et automation).
- `linkedin_connexion`, `facebook_connexion`, `instagram_connexion` (rÃ©seaux sociaux).

ğŸ‘‰ Chaque connexion est liÃ©e Ã  une organisation pour que les clÃ©s/API restent cloisonnÃ©es.

### 6.2 Abonnements & paiements
- `abonnement_stripe` : rattachement `organisation_id` â†’ gestion des abonnements.
- Les rÃ©seaux peuvent co-payer ou subventionner les agences membres.

---

## 7. SÃ‰CURITÃ‰ ET CLOISONNEMENT
1. RLS activÃ©e sur toutes les tables â†’ `organisation_id = auth.jwt().organisation_id`.
2. JWT enrichi avec organisation_id et rÃ´le mÃ©tier.
3. AccÃ¨s `admin_presenca` = seul capable de voir toutes les organisations (impersonation).
4. Audit logs pour tracer connexions, crÃ©ations, suppressions.

---

## 8. LOGIQUE OPÃ‰RATIONNELLE

### 8.1 Demande de compte
- Une personne fait une demande via la page login de lâ€™application.
- Cette demande ne crÃ©e **aucun compte actif** dans `auth.users`.
- Elle est stockÃ©e (ex. table `demandes_comptes`) en attente de validation.

### 8.2 Validation par Admin PRESENCA
- Dans lâ€™espace `/admin-presenca`, lâ€™admin consulte les demandes.
- Il accepte ou refuse.
- Si acceptÃ© :
  - CrÃ©ation manuelle du `auth.users` (Supabase Auth).
  - CrÃ©ation immÃ©diate du `users` liÃ© (`users.users_auth_id â†’ auth.users.id`).
  - CrÃ©ation immÃ©diate du `utilisateurs` liÃ© (`utilisateurs.utilisateur_auth_uid â†’ auth.users.id`).
  - Attribution de lâ€™organisation_id et du rÃ´le mÃ©tier (reseau_direction, responsable, collaborateur, etc.).

### 8.3 AccÃ¨s login
- Seuls les comptes validÃ©s par lâ€™admin sont capables de se connecter.
- Au login, Lovable lit le rÃ´le et lâ€™organisation_id depuis `utilisateurs`.
- Redirection automatique vers lâ€™espace correspondant :
  - `admin_presenca` â†’ `/admin-presenca`
  - `reseau / reseau_direction` â†’ `/espace-reseau`
  - autres (responsable / collaborateur) â†’ `/accueil-leadgenai`

### 8.4 CrÃ©ation de collaborateurs
- Une fois validÃ©e, une agence (ou un rÃ©seau) peut demander la crÃ©ation de comptes collaborateurs.
- Ces collaborateurs restent rattachÃ©s Ã  lâ€™organisation_id de lâ€™agence/rÃ©seau.
- Toujours soumis Ã  validation avant activation (pas dâ€™auto-onboarding).

---

## ğŸ¯ SYNTHÃˆSE
- **auth.users** : Auth pure.
- **users** : Profil systÃ¨me (miroir de auth.users, avec organisation et rÃ´les systÃ¨me).
- **utilisateurs** : Pivot mÃ©tier (type, rÃ´le mÃ©tier, statut, rattachement organisation).
- **organisations** : Multi-tenant cloisonnÃ©.
- **Tables hiÃ©rarchiques** : RÃ©seaux et agences (responsables, collaborateurs).
- **RLS partout** : sÃ©curitÃ© garantie.
- **IntÃ©grations externes** cloisonnÃ©es par organisation.

ğŸ‘‰ Cette structure assure simplicitÃ©, sÃ©curitÃ© et scalabilitÃ© SaaS.


# PENSE-BÃŠTE â€“ LeadGenAI AdBuilder

## RÃ©ponse 1 : Quâ€™est-ce que le â€œmÃ©tierâ€ dans la structure ?
Dans mon application, â€œmÃ©tierâ€ = **profil fonctionnel de lâ€™utilisateur** dans mon SaaS, c'est-Ã -dire : rÃ´le, permissions, rattachements.

- **Auth pur (table `users`)** : juste une identitÃ© technique (email, mot de passe). Aucune intelligence.
- **MÃ©tier (table `utilisateurs`)** : enrichit le compte technique avec le â€œprofil mÃ©tierâ€ â†’ nom, prÃ©nom, rÃ´le, type (responsable/collaborateur), organisation_id, statut, etc.

ğŸ‘‰ MÃ©tier = tout ce qui permet de travailler dans lâ€™app (hiÃ©rarchie, droits, rattachement).  
Câ€™est comme si **`users` Ã©tait une carte dâ€™identitÃ©**, et **`utilisateurs` le poste occupÃ© dans lâ€™entreprise** (directeur, collaborateur, etc.).

---

## RÃ©ponse 2 : Organisation = RÃ©seau ou Agence ?
- **RÃ©seau (`reseau`)** : c est une organisation de type â€œgroupeâ€.  
  Exemple : *Century 21 France* = une entrÃ©e dans `organisations`.  
- **Agence rÃ©seau (`reseau_agence`)** : ce n'est pas une organisation sÃ©parÃ©e, mais une entitÃ© rattachÃ©e au rÃ©seau.  
  - Elle peut choisir d'activer/dÃ©sactiver son abonnement (on le gÃ¨re via une table type `reseau_agence_abonnement`).  
  - Si elle arrÃªte â†’ cela ne casse pas le contrat cadre du rÃ©seau.  
  - Si le rÃ©seau arrÃªte â†’ cascade sur toutes ses agences rattachÃ©es.  
  - Si elle veut continuer seule â†’ elle bascule vers une `agence_independante` (nouvelle entrÃ©e `organisations`).  
- **Agence indÃ©pendante (`agence_independante`)** : une organisation Ã  part entiÃ¨re.  
  - Elle paie directement son abonnement.  
  - Elle est totalement autonome de tout rÃ©seau.

ğŸ‘‰ Dans mon schÃ©ma :  
- `organisations` = rÃ©seaux + agences indÃ©pendantes.  
- Les agences rÃ©seau sont rattachÃ©es Ã  un rÃ©seau via `reseau_id`, mais **ne sont pas des organisations Ã  part entiÃ¨re au sens strict**.

---

## RÃ©ponse 3 : Logique opÃ©rationnelle avec validation admin
Mon flux actuel = **admin-controlled onboarding**, pas de self-service signup.

### Processus :
1. **Demande de compte** :  
   - Soumise via la page login.  
   - Rien nâ€™est crÃ©Ã© dans `auth.users`.  
   - La demande est stockÃ©e (table `demandes_comptes`).  

2. **Validation admin PRESENCA** :  
   - Lâ€™admin accepte ou refuse.  
   - Si acceptÃ© : crÃ©ation manuelle de `auth.users`, puis de `users`, puis de `utilisateurs`.  
   - Attribution organisation_id + rÃ´le (reseau_direction, responsable, collaborateurâ€¦).  

3. **AccÃ¨s login** :  
   - Seuls les comptes validÃ©s peuvent se connecter.  
   - Les responsables peuvent demander des comptes collaborateurs, toujours validÃ©s avant activation.  

### Implication technique :
- Pas de hook post-signup automatique.  
- Lâ€™admin joue le rÃ´le de â€œhook humainâ€.  
- Plus tard : possible dâ€™ouvrir en mode hybride â†’ auto-signup avec statut â€œpendingâ€ + validation admin.

---

## ğŸ¯ SynthÃ¨se
1. **MÃ©tier** = profil enrichi (rÃ´le, droits, rattachements).  
2. **Organisation** = rÃ©seau ou agence indÃ©pendante (agence rÃ©seau = sous-entitÃ© rattachÃ©e).  Les agences rÃ©seau ne sont pas des organisations, mais des sous-entitÃ©s rattachÃ©es au rÃ©seau.
3. **Logique actuelle** = validation 100 % admin, aucun accÃ¨s direct aprÃ¨s demande. Les administrateurs PRESENCA crÃ©ent les comptes manuellement (`auth.users` + `users` + `utilisateurs`).  

