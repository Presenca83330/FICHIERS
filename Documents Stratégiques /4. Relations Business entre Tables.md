# RELATIONS-BUSINESS-ENTRE-TABLES – LeadGenAI AdBuilder (Version corrigée)

## 1. VUE D’ENSEMBLE STRATÉGIQUE
LeadGenAI AdBuilder repose sur une architecture multi-tenant cloisonnée. Chaque utilisateur appartient obligatoirement à une organisation (réseau ou agence indépendante). La table pivot **utilisateurs** incarne le profil métier enrichi de chaque compte connecté.

En résumé :
- **auth.users** = connexion technique (Supabase).
- **users** = profil système relié à auth.users.
- **utilisateurs** = profil métier pivot enrichi.
- **organisations** = cloisonnement tenant.
- Toutes les tables métiers (réseau, agences, responsables, collaborateurs) s’appuient sur ce triptyque.

---

## 2. TABLES ORGANISATIONNELLES

### 2.1 organisations
- Contient tous les clients : réseaux et agences indépendantes.
- Chaque organisation a un `organisation_id` unique.
- Sert de clé de cloisonnement dans toutes les policies RLS.

### 2.2 auth.users (Supabase)
- Table système gérée par Supabase (email, provider, UID).
- Purement technique : aucune logique métier dedans.

### 2.3 users (miroir système)
- Reliée 1:1 à `auth.users` via `users.users_auth_id → auth.users.id`.
- Contient les infos système et organisationnelles : email, rôle (`client`/`admin`), rôle système (`admin_presenca`, `superadmin`, `support`), interface par défaut, organisation_id.
- Sert de pivot interne pour toutes les FK de ton modèle.

### 2.4 utilisateurs (profil métier)
- Profil métier obligatoire relié à `auth.users` via `utilisateurs.utilisateur_auth_uid → auth.users.id`.
- Champs : prénom, nom, rôle métier (responsable/collaborateur), type de compte (reseau/agence_independante), téléphone, statut, organisation_id.
- C’est ici que tout le métier s’articule (accès, affichage, hiérarchie).

---

## 3. RELATION USERS ↔ UTILISATEURS
- Relation stricte 1:1 mais **via `auth.users`** :
  - `users.users_auth_id → auth.users.id`
  - `utilisateurs.utilisateur_auth_uid → auth.users.id`
- Contrainte UNIQUE : 1 entrée `auth.users` = 1 ligne `users` = 1 ligne `utilisateurs`.
- La suppression d’un `auth.users` entraîne la suppression en cascade des entrées `users` et `utilisateurs` correspondantes.
- Tous les accès Lovable et multi-tenant passent par **utilisateurs**.

---

## 4. STRUCTURES HIÉRARCHIQUES

### 4.1 Réseau
```
RÉSEAU (reseau)
├── DIRECTION RÉSEAU (reseau_direction)
└── AGENCES RÉSEAU (reseau_agence)
    ├── RESPONSABLE AGENCE (reseau_agence_responsable)
    └── COLLABORATEURS (reseau_agence_collaborateur)
```
- Un réseau (`reseau`) est une organisation.
- Ses agences (`reseau_agence`) sont rattachées au même `organisation_id`.
- Chaque responsable ou collaborateur est un utilisateur.

### 4.2 Agence indépendante
```
AGENCE INDÉPENDANTE (agence_independante)
├── RESPONSABLE (agence_independante_responsable)
└── COLLABORATEURS (agence_independante_collaborateur)
```
- Chaque agence indépendante est une organisation.
- Ses responsables et collaborateurs appartiennent à cette organisation_id.

---

## 5. RELATIONS CLÉS
- `utilisateurs.utilisateur_organisation_id → organisations.organisation_id` (pivot multi-tenant).
- `reseau_agence_responsable.utilisateur_id → utilisateurs.utilisateur_id`.
- `reseau_agence_collaborateur.utilisateur_id → utilisateurs.utilisateur_id`.
- `agence_independante_responsable.utilisateur_id → utilisateurs.utilisateur_id`.
- `agence_independante_collaborateur.utilisateur_id → utilisateurs.utilisateur_id`.

Ce schéma garantit que tout utilisateur métier est rattaché à une organisation et cloisonné par RLS.

---

## 6. INTÉGRATIONS EXTERNES

### 6.1 Marketing / CRM / IA
- `brevo_connexion` (Emailing).
- `zoho_connexion` (CRM).
- `openai_connexion` (IA rédaction et automation).
- `linkedin_connexion`, `facebook_connexion`, `instagram_connexion` (réseaux sociaux).

👉 Chaque connexion est liée à une organisation pour que les clés/API restent cloisonnées.

### 6.2 Abonnements & paiements
- `abonnement_stripe` : rattachement `organisation_id` → gestion des abonnements.
- Les réseaux peuvent co-payer ou subventionner les agences membres.

---

## 7. SÉCURITÉ ET CLOISONNEMENT
1. RLS activée sur toutes les tables → `organisation_id = auth.jwt().organisation_id`.
2. JWT enrichi avec organisation_id et rôle métier.
3. Accès `admin_presenca` = seul capable de voir toutes les organisations (impersonation).
4. Audit logs pour tracer connexions, créations, suppressions.

---

## 8. LOGIQUE OPÉRATIONNELLE

### 8.1 Demande de compte
- Une personne fait une demande via la page login de l’application.
- Cette demande ne crée **aucun compte actif** dans `auth.users`.
- Elle est stockée (ex. table `demandes_comptes`) en attente de validation.

### 8.2 Validation par Admin PRESENCA
- Dans l’espace `/admin-presenca`, l’admin consulte les demandes.
- Il accepte ou refuse.
- Si accepté :
  - Création manuelle du `auth.users` (Supabase Auth).
  - Création immédiate du `users` lié (`users.users_auth_id → auth.users.id`).
  - Création immédiate du `utilisateurs` lié (`utilisateurs.utilisateur_auth_uid → auth.users.id`).
  - Attribution de l’organisation_id et du rôle métier (reseau_direction, responsable, collaborateur, etc.).

### 8.3 Accès login
- Seuls les comptes validés par l’admin sont capables de se connecter.
- Au login, Lovable lit le rôle et l’organisation_id depuis `utilisateurs`.
- Redirection automatique vers l’espace correspondant :
  - `admin_presenca` → `/admin-presenca`
  - `reseau / reseau_direction` → `/espace-reseau`
  - autres (responsable / collaborateur) → `/accueil-leadgenai`

### 8.4 Création de collaborateurs
- Une fois validée, une agence (ou un réseau) peut demander la création de comptes collaborateurs.
- Ces collaborateurs restent rattachés à l’organisation_id de l’agence/réseau.
- Toujours soumis à validation avant activation (pas d’auto-onboarding).

---

## 🎯 SYNTHÈSE
- **auth.users** : Auth pure.
- **users** : Profil système (miroir de auth.users, avec organisation et rôles système).
- **utilisateurs** : Pivot métier (type, rôle métier, statut, rattachement organisation).
- **organisations** : Multi-tenant cloisonné.
- **Tables hiérarchiques** : Réseaux et agences (responsables, collaborateurs).
- **RLS partout** : sécurité garantie.
- **Intégrations externes** cloisonnées par organisation.

👉 Cette structure assure simplicité, sécurité et scalabilité SaaS.


# PENSE-BÊTE – LeadGenAI AdBuilder

## Réponse 1 : Qu’est-ce que le “métier” dans la structure ?
Dans mon application, “métier” = **profil fonctionnel de l’utilisateur** dans mon SaaS, c'est-à-dire : rôle, permissions, rattachements.

- **Auth pur (table `users`)** : juste une identité technique (email, mot de passe). Aucune intelligence.
- **Métier (table `utilisateurs`)** : enrichit le compte technique avec le “profil métier” → nom, prénom, rôle, type (responsable/collaborateur), organisation_id, statut, etc.

👉 Métier = tout ce qui permet de travailler dans l’app (hiérarchie, droits, rattachement).  
C’est comme si **`users` était une carte d’identité**, et **`utilisateurs` le poste occupé dans l’entreprise** (directeur, collaborateur, etc.).

---

## Réponse 2 : Organisation = Réseau ou Agence ?
- **Réseau (`reseau`)** : c est une organisation de type “groupe”.  
  Exemple : *Century 21 France* = une entrée dans `organisations`.  
- **Agence réseau (`reseau_agence`)** : ce n'est pas une organisation séparée, mais une entité rattachée au réseau.  
  - Elle peut choisir d'activer/désactiver son abonnement (on le gère via une table type `reseau_agence_abonnement`).  
  - Si elle arrête → cela ne casse pas le contrat cadre du réseau.  
  - Si le réseau arrête → cascade sur toutes ses agences rattachées.  
  - Si elle veut continuer seule → elle bascule vers une `agence_independante` (nouvelle entrée `organisations`).  
- **Agence indépendante (`agence_independante`)** : une organisation à part entière.  
  - Elle paie directement son abonnement.  
  - Elle est totalement autonome de tout réseau.

👉 Dans mon schéma :  
- `organisations` = réseaux + agences indépendantes.  
- Les agences réseau sont rattachées à un réseau via `reseau_id`, mais **ne sont pas des organisations à part entière au sens strict**.

---

## Réponse 3 : Logique opérationnelle avec validation admin
Mon flux actuel = **admin-controlled onboarding**, pas de self-service signup.

### Processus :
1. **Demande de compte** :  
   - Soumise via la page login.  
   - Rien n’est créé dans `auth.users`.  
   - La demande est stockée (table `demandes_comptes`).  

2. **Validation admin PRESENCA** :  
   - L’admin accepte ou refuse.  
   - Si accepté : création manuelle de `auth.users`, puis de `users`, puis de `utilisateurs`.  
   - Attribution organisation_id + rôle (reseau_direction, responsable, collaborateur…).  

3. **Accès login** :  
   - Seuls les comptes validés peuvent se connecter.  
   - Les responsables peuvent demander des comptes collaborateurs, toujours validés avant activation.  

### Implication technique :
- Pas de hook post-signup automatique.  
- L’admin joue le rôle de “hook humain”.  
- Plus tard : possible d’ouvrir en mode hybride → auto-signup avec statut “pending” + validation admin.

---

## 🎯 Synthèse
1. **Métier** = profil enrichi (rôle, droits, rattachements).  
2. **Organisation** = réseau ou agence indépendante (agence réseau = sous-entité rattachée).  Les agences réseau ne sont pas des organisations, mais des sous-entités rattachées au réseau.
3. **Logique actuelle** = validation 100 % admin, aucun accès direct après demande. Les administrateurs PRESENCA créent les comptes manuellement (`auth.users` + `users` + `utilisateurs`).  

